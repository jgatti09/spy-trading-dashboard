<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPY Swing Trading Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f4f6f8;
            color: #0d0d0d;
            min-height: 100vh;
            padding: 24px;
            line-height: 1.5;
        }
        
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #0d0d0d;
            margin-bottom: 8px;
            font-size: 2.75em;
            font-weight: 500;
            letter-spacing: -0.02em;
        }
        
        .subtitle {
            color: #6b7280;
            font-size: 1.1em;
            margin-bottom: 32px;
            font-weight: 400;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
            border: 1px solid #f0f0f0;
            transition: all 0.2s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }
        
        .card h2 {
            color: #0d0d0d;
            margin-bottom: 24px;
            font-size: 1.4em;
            font-weight: 500;
            letter-spacing: -0.01em;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 10px;
            color: #6b7280;
            font-weight: 500;
            font-size: 0.95em;
            letter-spacing: -0.01em;
        }
        
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 14px 16px;
            background: #fafafa;
            border: 1.5px solid #e5e7eb;
            border-radius: 12px;
            color: #0d0d0d;
            font-size: 1em;
            transition: all 0.15s ease;
            font-family: inherit;
        }
        
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #4f7cff;
            background: white;
            box-shadow: 0 0 0 3px rgba(79,124,255,0.08);
        }
        
        .zone-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        button {
            background: #4f7cff;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            width: 100%;
            margin-top: 10px;
            letter-spacing: -0.01em;
        }
        
        button:hover {
            background: #3d66e0;
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .signals {
            background: white;
            border-radius: 20px;
            padding: 32px;
            margin-top: 24px;
            border: 1px solid #f0f0f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }
        
        .signal-item {
            background: #fafafa;
            padding: 24px;
            margin-bottom: 16px;
            border-radius: 16px;
            border-left: 4px solid #4f7cff;
            transition: all 0.2s ease;
        }
        
        .signal-item:hover {
            background: #f5f5f5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .signal-item.call {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        
        .signal-item.put {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .signal-item.no-trade {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .signal-header {
            font-size: 1.25em;
            font-weight: 600;
            margin-bottom: 16px;
            color: #0d0d0d;
            letter-spacing: -0.02em;
        }
        
        .signal-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        
        .detail-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #f0f0f0;
        }
        
        .detail-label {
            color: #6b7280;
            font-size: 0.85em;
            font-weight: 500;
            margin-bottom: 6px;
        }
        
        .detail-value {
            color: #4f7cff;
            font-weight: 600;
            font-size: 1.2em;
            letter-spacing: -0.01em;
        }
        
        .alert-box {
            background: #fffbeb;
            border: 1.5px solid #fde68a;
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
        }
        
        .alert-box h3 {
            color: #92400e;
            margin-bottom: 16px;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .zone-list {
            max-height: 240px;
            overflow-y: auto;
            margin-top: 12px;
        }
        
        .zone-item {
            background: white;
            padding: 16px;
            margin-bottom: 10px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #f0f0f0;
            transition: all 0.15s ease;
        }
        
        .zone-item:hover {
            border-color: #e5e7eb;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }
        
        .remove-zone {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            transition: all 0.15s ease;
        }
        
        .remove-zone:hover {
            background: #dc2626;
        }
        
        .save-indicator {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 14px 20px;
            background: white;
            color: #10b981;
            border-radius: 12px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
            border: 1.5px solid #10b981;
            box-shadow: 0 4px 12px rgba(16,185,129,0.15);
            z-index: 1000;
        }
        
        .save-indicator.show {
            opacity: 1;
        }
        
        .last-updated {
            text-align: center;
            color: #6b7280;
            font-size: 0.95em;
            margin-bottom: 24px;
            font-weight: 500;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .tab-button {
            transition: all 0.15s ease;
            background: white;
            border: 1.5px solid #f0f0f0;
            color: #6b7280;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        
        .tab-button:hover {
            background: #fafafa;
            border-color: #e5e7eb;
            color: #0d0d0d;
        }
        
        .tab-button.active {
            background: #4f7cff !important;
            border-color: #4f7cff !important;
            color: white !important;
            box-shadow: 0 2px 8px rgba(79,124,255,0.25);
        }
        
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #fafafa;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #fafafa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #f0f0f0;
        }
        
        .stat-label {
            font-size: 0.85em;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 1.6em;
            font-weight: 600;
            color: #0d0d0d;
            letter-spacing: -0.01em;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <h1>SPY Swing Trading</h1>
        <p class="subtitle">Live market data powered by Polygon.io API</p>
        
        <div style="display: flex; gap: 12px; margin-bottom: 32px; flex-wrap: wrap;">
            <button onclick="showPage('dashboard')" id="dashboardTab" class="tab-button active" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; width: auto;">
                Dashboard
            </button>
            <button onclick="showPage('tradelog')" id="tradelogTab" class="tab-button" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; width: auto;">
                Trade Log
            </button>
            <button onclick="showPage('weekly')" id="weeklyTab" class="tab-button" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; width: auto;">
                Weekly Recap
            </button>
        </div>
        
        <div class="last-updated" id="lastUpdated">Loading...</div>
        
        <!-- DASHBOARD PAGE -->
        <div id="dashboardPage" class="page active">
            <div class="signals" id="topSignals" style="margin-bottom: 24px;">
                <h2 style="color: #0d0d0d; margin-bottom: 20px; font-weight: 600;">Trade Signals & Alerts</h2>
                <div id="signalContent">
                    <p style="text-align: center; color: #6b7280;">Connect API to generate signals...</p>
                </div>
                <div id="nextSetupContent" style="margin-top: 24px;"></div>
            </div>
            
            <div class="grid">
                <div class="card">
                    <h2>Live Market Data</h2>
                    <div class="input-group">
                        <label>Polygon.io API Key</label>
                        <div style="display: flex; gap: 12px;">
                            <input type="password" id="polygonApiKey" placeholder="Enter your API key">
                            <button onclick="connectPolygon()" style="width: auto; margin: 0; padding: 12px 20px;">Connect</button>
                        </div>
                    </div>
                    <div id="priceDisplay" style="margin-top: 12px; padding: 20px; background: #fafafa; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-size: 0.9em; color: #6b7280;">SPY Price</div>
                            <div id="connectionStatus" style="padding: 6px 12px; background: #fee2e2; color: #991b1b; border-radius: 8px; font-size: 0.85em; font-weight: 600;">
                                Disconnected
                            </div>
                        </div>
                        <div id="currentPrice" style="font-size: 2.5em; font-weight: 700; color: #0d0d0d; margin-bottom: 8px;">--</div>
                        <div id="priceChange" style="font-size: 1.1em; font-weight: 600; margin-bottom: 8px;">--</div>
                        <div id="lastUpdate" style="font-size: 0.85em; color: #6b7280;">No data</div>
                    </div>
                    <div class="input-group">
                        <label>4-Hour Trend</label>
                        <select id="trend">
                            <option value="neutral">Neutral/Sideways</option>
                            <option value="up">Uptrend</option>
                            <option value="down">Downtrend</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Last Candle (4H)</label>
                        <select id="lastCandle">
                            <option value="green">Green (Bullish)</option>
                            <option value="red">Red (Bearish)</option>
                        </select>
                    </div>
                    <button onclick="saveAllData()">Save Settings</button>
                </div>
                
                <div class="card">
                    <h2>Zone Management</h2>
                    <div class="input-group">
                        <label>Supply/Resistance Zone</label>
                        <div class="zone-inputs">
                            <input type="number" id="supplyTop" step="0.01" placeholder="Top">
                            <input type="number" id="supplyBottom" step="0.01" placeholder="Bottom">
                        </div>
                        <button onclick="addZone('supply')">Add Supply Zone</button>
                    </div>
                    <div class="input-group">
                        <label>Demand/Support Zone</label>
                        <div class="zone-inputs">
                            <input type="number" id="demandTop" step="0.01" placeholder="Top">
                            <input type="number" id="demandBottom" step="0.01" placeholder="Bottom">
                        </div>
                        <button onclick="addZone('demand')">Add Demand Zone</button>
                    </div>
                    <div class="zone-list" id="zoneList"></div>
                    <button onclick="clearAllZones()" style="background: #ef4444; margin-top: 12px;">Clear All Zones</button>
                    <button onclick="loadHistoricalData()" style="background: #10b981; margin-top: 12px;">üìä Analyze Historical Performance</button>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 24px;">
                <h2>Performance Overview</h2>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Trades</div>
                        <div class="stat-value" id="totalTrades">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Win Rate</div>
                        <div class="stat-value" style="color: #10b981;" id="winRate">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total P&L</div>
                        <div class="stat-value" style="color: #4f7cff;" id="totalPL">$0</div>
                    </div>
                </div>
            </div>
            
            <div id="historicalAnalysis"></div>
            
            <div class="alert-box">
                <h3>Strategy Reminder</h3>
                <ul style="list-style: none; padding-left: 0; color: #0d0d0d;">
                    <li style="margin-bottom: 8px;">‚Ä¢ Entry: Price enters zone + reversal candle (or 2+ hours momentum)</li>
                    <li style="margin-bottom: 8px;">‚Ä¢ Stop Loss: Middle of zone (conservative) or opposite side (aggressive)</li>
                    <li style="margin-bottom: 8px;">‚Ä¢ Take Profit: Next closest zone from price</li>
                    <li style="margin-bottom: 8px;">‚Ä¢ Options: Always 7 DTE, first ITM strike</li>
                    <li>‚Ä¢ Risk: Only 4% gap risk, plenty of time to manage trades</li>
                </ul>
            </div>
        </div>
        
        <!-- TRADE LOG PAGE -->
        <div id="tradelogPage" class="page">
            <div class="card">
                <h2>Trade Log</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Track your trades and analyze performance.</p>
                
                <div style="background: #fafafa; padding: 20px; border-radius: 16px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 16px;">Log New Trade</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div class="input-group" style="margin: 0;">
                            <label>Trade Type</label>
                            <select id="logTradeType">
                                <option value="call">CALL</option>
                                <option value="put">PUT</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Zone</label>
                            <input type="text" id="logZone" placeholder="658-663">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Entry Date/Time</label>
                            <input type="datetime-local" id="logEntryDateTime">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Entry Price</label>
                            <input type="number" id="logEntryPrice" step="0.01" placeholder="659.50">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Entry Contract Price</label>
                            <input type="number" id="logEntryContractPrice" step="0.01" placeholder="4.50">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Contracts</label>
                            <input type="number" id="logContracts" placeholder="1">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Exit Date/Time</label>
                            <input type="datetime-local" id="logExitDateTime">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Exit Price</label>
                            <input type="number" id="logExitPrice" step="0.01" placeholder="663.00">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Exit Contract Price</label>
                            <input type="number" id="logExitContractPrice" step="0.01" placeholder="7.80">
                        </div>
                    </div>
                    <button onclick="logTrade()">Log Trade</button>
                </div>
                
                <div id="tradeLogList"></div>
            </div>
        </div>
        
        <!-- WEEKLY RECAP PAGE -->
        <div id="weeklyPage" class="page">
            <div class="card">
                <h2>Weekly Recap</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Track your weekly performance and key observations.</p>
                
                <div class="input-group">
                    <label>Week Starting</label>
                    <input type="date" id="weekDate">
                </div>
                
                <div style="background: #f0fdf4; padding: 20px; border-radius: 16px; margin: 20px 0; border: 1px solid #d1fae5;">
                    <h3 style="color: #065f46; margin-bottom: 16px;">Log Winning Trades</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div class="input-group" style="margin: 0;">
                            <label>Trade Type</label>
                            <select id="weeklyTradeType">
                                <option value="CALL">CALL</option>
                                <option value="PUT">PUT</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Zone</label>
                            <input type="text" id="weeklyZone" placeholder="658-663">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Entry Date/Time</label>
                            <input type="datetime-local" id="weeklyEntryDateTime">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Entry Price</label>
                            <input type="number" id="weeklyEntryPrice" step="0.01">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Exit Date/Time</label>
                            <input type="datetime-local" id="weeklyExitDateTime">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Exit Price</label>
                            <input type="number" id="weeklyExitPrice" step="0.01">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Entry Contract Price</label>
                            <input type="number" id="weeklyEntryContractPrice" step="0.01">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Exit Contract Price</label>
                            <input type="number" id="weeklyExitContractPrice" step="0.01">
                        </div>
                    </div>
                    <button onclick="addWeeklyTrade()" style="background: #10b981;">Add Trade</button>
                    <div id="weeklyTradesList" style="margin-top: 16px;"></div>
                </div>
                
                <div style="background: #fffbeb; padding: 20px; border-radius: 16px; margin: 20px 0; border: 1px solid #fef3c7;">
                    <h3 style="color: #92400e; margin-bottom: 16px;">Pattern Analysis</h3>
                    <div id="patternAnalysis">
                        <p>Add winning trades to see pattern analysis.</p>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Key Observations</label>
                    <textarea id="weeklyNotes" style="min-height: 100px;" placeholder="Enter key observations from your instructor..."></textarea>
                </div>
                
                <button onclick="saveWeeklyRecap()">Save Recap</button>
                
                <div id="recapHistory" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>
    
    <div class="save-indicator" id="saveIndicator">‚úì Saved</div>
    
    <script>
        let zones = { supply: [], demand: [] };
        let polygonApiKey = '';
        let currentPrice = 0;
        let priceHistory = [];
        let updateInterval = null;
        let zoneAlertChecked = {};
        
        async function connectPolygon() {
            const apiKey = document.getElementById('polygonApiKey').value.trim();
            if (!apiKey) {
                alert('Please enter your Polygon.io API key');
                return;
            }
            
            polygonApiKey = apiKey;
            localStorage.setItem('polygonApiKey', apiKey);
            
            try {
                await updateLivePrice();
                document.getElementById('connectionStatus').style.background = '#d1fae5';
                document.getElementById('connectionStatus').style.color = '#065f46';
                document.getElementById('connectionStatus').textContent = 'Connected ‚úì';
                
                if (updateInterval) clearInterval(updateInterval);
                updateInterval = setInterval(updateLivePrice, 15000);
                
                showSaveIndicator();
            } catch (error) {
                alert('Connection failed: ' + error.message);
            }
        }
        
        async function updateLivePrice() {
            if (!polygonApiKey) return;
            
            try {
                const response = await fetch(
                    `https://api.polygon.io/v2/aggs/ticker/SPY/prev?adjusted=true&apiKey=${polygonApiKey}`
                );
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'OK' && data.results && data.results.length > 0) {
                    const result = data.results[0];
                    const lastPrice = result.c;
                    const prevClose = result.o;
                    const change = lastPrice - prevClose;
                    const changePercent = prevClose ? (change / prevClose) * 100 : 0;
                    
                    currentPrice = lastPrice;
                    
                    document.getElementById('currentPrice').textContent = lastPrice.toFixed(2);
                    
                    const priceChangeEl = document.getElementById('priceChange');
                    const changeSign = change >= 0 ? '+' : '';
                    priceChangeEl.textContent = `${changeSign}${change.toFixed(2)} (${changeSign}${changePercent.toFixed(2)}%)`;
                    priceChangeEl.style.color = change >= 0 ? '#10b981' : '#ef4444';
                    
                    document.getElementById('lastUpdate').textContent = 
                        `Updated: ${new Date().toLocaleTimeString()}`;
                    
                    priceHistory.push({ price: lastPrice, timestamp: Date.now() });
                    if (priceHistory.length > 100) priceHistory.shift();
                    
                    checkZoneAlerts(lastPrice);
                    generateSignals();
                    
                    localStorage.setItem('lastLivePrice', JSON.stringify({
                        price: lastPrice,
                        timestamp: Date.now()
                    }));
                }
            } catch (error) {
                console.error('Price update failed:', error);
                document.getElementById('lastUpdate').textContent = 'Update failed: ' + error.message;
            }
        }
        
        function checkZoneAlerts(price) {
            zones.supply.forEach((zone, index) => {
                const zoneKey = `supply_${index}`;
                const isInZone = price >= zone.bottom && price <= zone.top;
                
                if (isInZone && !zoneAlertChecked[zoneKey]) {
                    zoneAlertChecked[zoneKey] = true;
                    showAlert(`üî¥ PUT Setup: Price entered supply zone ${zone.bottom.toFixed(2)}-${zone.top.toFixed(2)}`);
                } else if (!isInZone) {
                    zoneAlertChecked[zoneKey] = false;
                }
            });
            
            zones.demand.forEach((zone, index) => {
                const zoneKey = `demand_${index}`;
                const isInZone = price >= zone.bottom && price <= zone.top;
                
                if (isInZone && !zoneAlertChecked[zoneKey]) {
                    zoneAlertChecked[zoneKey] = true;
                    showAlert(`üü¢ CALL Setup: Price entered demand zone ${zone.bottom.toFixed(2)}-${zone.top.toFixed(2)}`);
                } else if (!isInZone) {
                    zoneAlertChecked[zoneKey] = false;
                }
            });
        }
        
        function showAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = 'position: fixed; top: 80px; right: 24px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-left: 4px solid #4f7cff; max-width: 400px; z-index: 2000;';
            alertDiv.innerHTML = `<div style="font-weight: 600; margin-bottom: 8px;">${message}</div><div style="font-size: 0.85em; color: #6b7280;">Look for reversal candle confirmation</div>`;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => alertDiv.remove(), 8000);
        }
        
        async function loadHistoricalData() {
            if (!polygonApiKey) {
                alert('Please connect to Polygon.io first');
                return;
            }
            
            if (zones.supply.length === 0 && zones.demand.length === 0) {
                alert('Please add some zones first');
                return;
            }
            
            const analysisDiv = document.getElementById('historicalAnalysis');
            analysisDiv.innerHTML = '<div class="card"><h2>Loading Historical Data...</h2><p style="color: #6b7280;">Fetching 5 years of SPY data from Polygon.io...</p></div>';
            
            try {
                const to = new Date();
                const from = new Date();
                from.setFullYear(from.getFullYear() - 5);
                
                const fromStr = from.toISOString().split('T')[0];
                const toStr = to.toISOString().split('T')[0];
                
                const response = await fetch(
                    `https://api.polygon.io/v2/aggs/ticker/SPY/range/1/day/${fromStr}/${toStr}?adjusted=true&sort=asc&limit=50000&apiKey=${polygonApiKey}`
                );
                
                if (!response.ok) {
                    throw new Error('Failed to load historical data');
                }
                
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    analyzeHistoricalZones(data.results);
                } else {
                    alert('No historical data available');
                }
            } catch (error) {
                analysisDiv.innerHTML = `<div class="card"><h2>Error Loading Data</h2><p style="color: #ef4444;">${error.message}</p></div>`;
            }
        }
        
        function analyzeHistoricalZones(historicalData) {
            const analysis = {
                supplyZoneTests: [],
                demandZoneTests: []
            };
            
            zones.supply.forEach((zone) => {
                let tests = 0;
                let bounces = 0;
                
                for (let i = 1; i < historicalData.length; i++) {
                    const candle = historicalData[i];
                    
                    if (candle.h >= zone.bottom && candle.l <= zone.top) {
                        tests++;
                        if (candle.c < candle.o) bounces++;
                    }
                }
                
                analysis.supplyZoneTests.push({
                    zone: zone,
                    tests: tests,
                    bounces: bounces,
                    successRate: tests > 0 ? (bounces / tests * 100).toFixed(1) : 0
                });
            });
            
            zones.demand.forEach((zone) => {
                let tests = 0;
                let bounces = 0;
                
                for (let i = 1; i < historicalData.length; i++) {
                    const candle = historicalData[i];
                    
                    if (candle.l <= zone.top && candle.h >= zone.bottom) {
                        tests++;
                        if (candle.c > candle.o) bounces++;
                    }
                }
                
                analysis.demandZoneTests.push({
                    zone: zone,
                    tests: tests,
                    bounces: bounces,
                    successRate: tests > 0 ? (bounces / tests * 100).toFixed(1) : 0
                });
            });
            
            displayZoneAnalysis(analysis, historicalData.length);
        }
        
        function displayZoneAnalysis(analysis, totalDays) {
            let html = '<div class="card" style="margin-top: 24px;"><h2>üìä Historical Zone Performance (5 Years)</h2>';
            html += `<p style="color: #6b7280; margin-bottom: 20px;">Analyzed ${totalDays} trading days</p>`;
            
            if (analysis.supplyZoneTests.length > 0) {
                html += '<h3 style="color: #ef4444; margin-top: 16px; margin-bottom: 12px;">üî¥ Supply Zones</h3>';
                analysis.supplyZoneTests.forEach(test => {
                    const quality = test.successRate >= 70 ? 'üî• Strong' : test.successRate >= 50 ? '‚úì Good' : '‚ö†Ô∏è Weak';
                    html += `
                        <div style="background: #fafafa; padding: 20px; margin-bottom: 12px; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-weight: 600; color: #0d0d0d;">Zone: ${test.zone.bottom.toFixed(2)} - ${test.zone.top.toFixed(2)}</div>
                                <div style="font-weight: 600; color: ${test.successRate >= 70 ? '#10b981' : test.successRate >= 50 ? '#f59e0b' : '#ef4444'};">${quality}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                <div style="background: white; padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.85em; color: #6b7280;">Tests</div>
                                    <div style="font-weight: 600; color: #0d0d0d; font-size: 1.3em;">${test.tests}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.85em; color: #6b7280;">Bounces</div>
                                    <div style="font-weight: 600; color: #0d0d0d; font-size: 1.3em;">${test.bounces}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.85em; color: #6b7280;">Success Rate</div>
                                    <div style="font-weight: 600; color: #10b981; font-size: 1.3em;">${test.successRate}%</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            if (analysis.demandZoneTests.length > 0) {
                html += '<h3 style="color: #10b981; margin-top: 24px; margin-bottom: 12px;">üü¢ Demand Zones</h3>';
                analysis.demandZoneTests.forEach(test => {
                    const quality = test.successRate >= 70 ? 'üî• Strong' : test.successRate >= 50 ? '‚úì Good' : '‚ö†Ô∏è Weak';
                    html += `
                        <div style="background: #fafafa; padding: 20px; margin-bottom: 12px; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-weight: 600; color: #0d0d0d;">Zone: ${test.zone.bottom.toFixed(2)} - ${test.zone.top.toFixed(2)}</div>
                                <div style="font-weight: 600; color: ${test.successRate >= 70 ? '#10b981' : test.successRate >= 50 ? '#f59e0b' : '#ef4444'};">${quality}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                <div style="background: white; padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.85em; color: #6b7280;">Tests</div>
                                    <div style="font-weight: 600; color: #0d0d0d; font-size: 1.3em;">${test.tests}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.85em; color: #6b7280;">Bounces</div>
                                    <div style="font-weight: 600; color: #0d0d0d; font-size: 1.3em;">${test.bounces}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.85em; color: #6b7280;">Success Rate</div>
                                    <div style="font-weight: 600; color: #10b981; font-size: 1.3em;">${test.successRate}%</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            
            document.getElementById('historicalAnalysis').innerHTML = html;
        }
        
        function loadSavedData() {
            try {
                const savedZones = localStorage.getItem('tradingZones');
                if (savedZones) zones = JSON.parse(savedZones);
                
                const savedApiKey = localStorage.getItem('polygonApiKey');
                if (savedApiKey) {
                    document.getElementById('polygonApiKey').value = savedApiKey;
                    polygonApiKey = savedApiKey;
                    setTimeout(() => connectPolygon(), 1000);
                }
                
                const savedMarketData = localStorage.getItem('marketData');
                if (savedMarketData) {
                    const data = JSON.parse(savedMarketData);
                    document.getElementById('trend').value = data.trend || 'neutral';
                    document.getElementById('lastCandle').value = data.lastCandle || 'green';
                }
                
                const lastSaved = localStorage.getItem('lastSaved');
                document.getElementById('lastUpdated').textContent = lastSaved ? 
                    `Last updated ${new Date(lastSaved).toLocaleString()}` : 'No saved data';
                
                updateZoneList();
                generateSignals();
                updateStats();
                displayWeeklyTrades();
                updatePatternAnalysis();
                displayRecapHistory();
                displayTradeLogs();
            } catch (error) {
                console.error('Error loading:', error);
            }
        }
        
        function saveAllData() {
            try {
                localStorage.setItem('tradingZones', JSON.stringify(zones));
                localStorage.setItem('marketData', JSON.stringify({
                    trend: document.getElementById('trend').value,
                    lastCandle: document.getElementById('lastCandle').value,
                    timestamp: new Date().toISOString()
                }));
                localStorage.setItem('lastSaved', new Date().toISOString());
                showSaveIndicator();
                document.getElementById('lastUpdated').textContent = 
                    `Last updated ${new Date().toLocaleString()}`;
            } catch (error) {
                alert('Error saving data');
            }
        }
        
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }
        
        function addZone(type) {
            const topInput = type === 'supply' ? 'supplyTop' : 'demandTop';
            const bottomInput = type === 'supply' ? 'supplyBottom' : 'demandBottom';
            const top = parseFloat(document.getElementById(topInput).value);
            const bottom = parseFloat(document.getElementById(bottomInput).value);
            
            if (top && bottom && top > bottom) {
                zones[type].push({ top, bottom });
                updateZoneList();
                document.getElementById(topInput).value = '';
                document.getElementById(bottomInput).value = '';
                generateSignals();
                saveAllData();
            } else {
                alert('Please enter valid zone values (top must be > bottom)');
            }
        }
        
        function removeZone(type, index) {
            zones[type].splice(index, 1);
            updateZoneList();
            generateSignals();
            saveAllData();
        }
        
        function clearAllZones() {
            if (confirm('Clear all zones?')) {
                zones.supply = [];
                zones.demand = [];
                updateZoneList();
                generateSignals();
                saveAllData();
            }
        }
        
        function updateZoneList() {
            const list = document.getElementById('zoneList');
            let html = '';
            
            zones.supply.forEach((zone, i) => {
                html += `<div class="zone-item">
                    <span style="color: #0d0d0d; font-weight: 500;">üî¥ Supply: ${zone.top.toFixed(2)} - ${zone.bottom.toFixed(2)}</span>
                    <button class="remove-zone" onclick="removeZone('supply', ${i})">Remove</button>
                </div>`;
            });
            
            zones.demand.forEach((zone, i) => {
                html += `<div class="zone-item">
                    <span style="color: #0d0d0d; font-weight: 500;">üü¢ Demand: ${zone.top.toFixed(2)} - ${zone.bottom.toFixed(2)}</span>
                    <button class="remove-zone" onclick="removeZone('demand', ${i})">Remove</button>
                </div>`;
            });
            
            list.innerHTML = html || '<p style="color: #6b7280; text-align: center; padding: 12px;">No zones added</p>';
        }
        
        function generateSignals() {
            const price = currentPrice || 0;
            const trend = document.getElementById('trend').value;
            const lastCandle = document.getElementById('lastCandle').value;
            
            if (!price) {
                document.getElementById('signalContent').innerHTML = 
                    '<p style="text-align: center; color: #6b7280;">Waiting for live price data...</p>';
                return;
            }
            
            let signals = [];
            
            zones.supply.forEach(zone => {
                if (price >= zone.bottom && price <= zone.top) {
                    signals.push({
                        type: 'put',
                        zone: zone,
                        entry: 'POTENTIAL PUT ENTRY',
                        condition: lastCandle === 'red' ? 'Strong Signal' : 'Wait for Reversal',
                        stopLoss: zone.top + ((zone.top - zone.bottom) * 0.5),
                        takeProfit: findNextZone('down', price),
                        trend: trend === 'down' ? 'With Trend ‚úì' : trend === 'up' ? 'Against Trend ‚ö†Ô∏è' : 'Neutral'
                    });
                }
            });
            
            zones.demand.forEach(zone => {
                if (price >= zone.bottom && price <= zone.top) {
                    signals.push({
                        type: 'call',
                        zone: zone,
                        entry: 'POTENTIAL CALL ENTRY',
                        condition: lastCandle === 'green' ? 'Strong Signal' : 'Wait for Reversal',
                        stopLoss: zone.bottom - ((zone.top - zone.bottom) * 0.5),
                        takeProfit: findNextZone('up', price),
                        trend: trend === 'up' ? 'With Trend ‚úì' : trend === 'down' ? 'Against Trend ‚ö†Ô∏è' : 'Neutral'
                    });
                }
            });
            
            displaySignals(signals, price);
        }
        
        function findNextZone(direction, currentPrice) {
            let targetZone = null;
            
            if (direction === 'up') {
                zones.supply.forEach(zone => {
                    if (zone.bottom > currentPrice) {
                        if (!targetZone || zone.bottom < targetZone.bottom) {
                            targetZone = zone;
                        }
                    }
                });
            } else {
                zones.demand.forEach(zone => {
                    if (zone.top < currentPrice) {
                        if (!targetZone || zone.top > targetZone.top) {
                            targetZone = zone;
                        }
                    }
                });
            }
            
            return targetZone ? `${targetZone.bottom.toFixed(2)} - ${targetZone.top.toFixed(2)}` : 'No zone';
        }
        
        function displaySignals(signals, price) {
            let html = '';
            
            if (signals.length === 0) {
                html = `<div class="signal-item no-trade">
                    <div class="signal-header">No Active Signals</div>
                    <p style="color: #6b7280;">Price ${price.toFixed(2)} not in any zones. Wait for zone entry.</p>
                </div>`;
            } else {
                signals.forEach(signal => {
                    const className = signal.type === 'call' ? 'call' : 'put';
                    const emoji = signal.type === 'call' ? 'üü¢' : 'üî¥';
                    
                    html += `<div class="signal-item ${className}">
                        <div class="signal-header">${emoji} ${signal.entry}</div>
                        <p style="color: #0d0d0d; margin-bottom: 8px;">Zone: ${signal.zone.bottom.toFixed(2)} - ${signal.zone.top.toFixed(2)}</p>
                        <p style="color: #6b7280; font-size: 0.9em;">Status: ${signal.condition} ‚Ä¢ ${signal.trend}</p>
                        <div class="signal-details">
                            <div class="detail-item">
                                <div class="detail-label">Entry</div>
                                <div class="detail-value">${price.toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Stop Loss</div>
                                <div class="detail-value">${signal.stopLoss.toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Take Profit</div>
                                <div class="detail-value">${signal.takeProfit}</div>
                            </div>
                        </div>
                    </div>`;
                });
            }
            
            document.getElementById('signalContent').innerHTML = html;
        }
        
        function updateStats() {
            const trades = JSON.parse(localStorage.getItem('tradeLogs') || '[]');
            const closed = trades.filter(t => t.exitPrice);
            const winners = closed.filter(t => {
                const pl = (t.exitContractPrice - t.entryContractPrice) * 100 * (t.contracts || 1);
                return pl > 0;
            }).length;
            const totalPL = closed.reduce((sum, t) => {
                return sum + ((t.exitContractPrice - t.entryContractPrice) * 100 * (t.contracts || 1));
            }, 0);
            
            document.getElementById('totalTrades').textContent = closed.length;
            document.getElementById('winRate').textContent = closed.length ? 
                ((winners / closed.length) * 100).toFixed(1) + '%' : '0%';
            document.getElementById('totalPL').textContent = '$' + totalPL.toFixed(2);
        }
        
        function logTrade() {
            const trade = {
                id: Date.now(),
                type: document.getElementById('logTradeType').value,
                zone: document.getElementById('logZone').value,
                entryDateTime: document.getElementById('logEntryDateTime').value,
                entryPrice: parseFloat(document.getElementById('logEntryPrice').value),
                entryContractPrice: parseFloat(document.getElementById('logEntryContractPrice').value),
                contracts: parseInt(document.getElementById('logContracts').value) || 1,
                exitDateTime: document.getElementById('logExitDateTime').value,
                exitPrice: parseFloat(document.getElementById('logExitPrice').value),
                exitContractPrice: parseFloat(document.getElementById('logExitContractPrice').value)
            };
            
            if (!trade.zone || !trade.entryDateTime || !trade.entryPrice || !trade.entryContractPrice) {
                alert('Please fill in all required fields');
                return;
            }
            
            let trades = JSON.parse(localStorage.getItem('tradeLogs') || '[]');
            trades.push(trade);
            localStorage.setItem('tradeLogs', JSON.stringify(trades));
            
            // Clear inputs
            document.getElementById('logZone').value = '';
            document.getElementById('logEntryDateTime').value = '';
            document.getElementById('logEntryPrice').value = '';
            document.getElementById('logEntryContractPrice').value = '';
            document.getElementById('logContracts').value = '';
            document.getElementById('logExitDateTime').value = '';
            document.getElementById('logExitPrice').value = '';
            document.getElementById('logExitContractPrice').value = '';
            
            displayTradeLogs();
            updateStats();
            showSaveIndicator();
        }
        
        function displayTradeLogs() {
            const trades = JSON.parse(localStorage.getItem('tradeLogs') || '[]');
            const listEl = document.getElementById('tradeLogList');
            
            if (trades.length === 0) {
                listEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No trades logged yet</p>';
                return;
            }
            
            let html = '<h3 style="margin-bottom: 16px;">Trade History</h3>';
            
            trades.reverse().forEach((trade, index) => {
                const pl = trade.exitContractPrice ? 
                    (trade.exitContractPrice - trade.entryContractPrice) * 100 * trade.contracts : 0;
                const plColor = pl >= 0 ? '#10b981' : '#ef4444';
                
                html += `
                    <div style="background: #fafafa; padding: 20px; margin-bottom: 12px; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                            <div>
                                <strong style="color: ${trade.type === 'call' ? '#10b981' : '#ef4444'};">
                                    ${trade.type.toUpperCase()} ‚Ä¢ Zone: ${trade.zone}
                                </strong>
                            </div>
                            ${trade.exitContractPrice ? 
                                `<div style="font-size: 1.2em; font-weight: 700; color: ${plColor};">
                                    ${pl >= 0 ? '+' : ''}$${pl.toFixed(2)}
                                </div>` : 
                                '<div style="color: #6b7280;">Open</div>'
                            }
                        </div>
                        <div style="font-size: 0.9em; color: #6b7280;">
                            <div>Entry: ${trade.entryPrice} @ $${trade.entryContractPrice} ‚Ä¢ ${new Date(trade.entryDateTime).toLocaleString()}</div>
                            ${trade.exitPrice ? 
                                `<div>Exit: ${trade.exitPrice} @ $${trade.exitContractPrice} ‚Ä¢ ${new Date(trade.exitDateTime).toLocaleString()}</div>` : 
                                ''
                            }
                            <div>Contracts: ${trade.contracts}</div>
                        </div>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }
        
        function addWeeklyTrade() {
            const trade = {
                id: Date.now(),
                type: document.getElementById('weeklyTradeType').value,
                zone: document.getElementById('weeklyZone').value,
                entryDateTime: document.getElementById('weeklyEntryDateTime').value,
                entryPrice: parseFloat(document.getElementById('weeklyEntryPrice').value),
                exitDateTime: document.getElementById('weeklyExitDateTime').value,
                exitPrice: parseFloat(document.getElementById('weeklyExitPrice').value),
                entryContractPrice: parseFloat(document.getElementById('weeklyEntryContractPrice').value),
                exitContractPrice: parseFloat(document.getElementById('weeklyExitContractPrice').value),
                profitLoss: (parseFloat(document.getElementById('weeklyExitContractPrice').value) - 
                            parseFloat(document.getElementById('weeklyEntryContractPrice').value)) * 100
            };
            
            if (!trade.zone || !trade.entryDateTime || !trade.exitDateTime) {
                alert('Please fill in all fields');
                return;
            }
            
            let weeklyTrades = JSON.parse(localStorage.getItem('weeklyTrades') || '[]');
            weeklyTrades.push(trade);
            localStorage.setItem('weeklyTrades', JSON.stringify(weeklyTrades));
            
            // Clear inputs
            document.getElementById('weeklyZone').value = '';
            document.getElementById('weeklyEntryDateTime').value = '';
            document.getElementById('weeklyEntryPrice').value = '';
            document.getElementById('weeklyExitDateTime').value = '';
            document.getElementById('weeklyExitPrice').value = '';
            document.getElementById('weeklyEntryContractPrice').value = '';
            document.getElementById('weeklyExitContractPrice').value = '';
            
            displayWeeklyTrades();
            updatePatternAnalysis();
            showSaveIndicator();
        }
        
        function displayWeeklyTrades() {
            const trades = JSON.parse(localStorage.getItem('weeklyTrades') || '[]');
            const listEl = document.getElementById('weeklyTradesList');
            
            if (trades.length === 0) {
                listEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 12px;">No trades this week</p>';
                return;
            }
            
            let totalPL = 0;
            let html = '';
            
            trades.forEach((trade, index) => {
                totalPL += trade.profitLoss;
                const plColor = trade.profitLoss >= 0 ? '#10b981' : '#ef4444';
                
                html += `
                    <div style="background: white; padding: 16px; margin-bottom: 10px; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <strong style="color: ${trade.type === 'CALL' ? '#10b981' : '#ef4444'};">
                                ${trade.type} ‚Ä¢ ${trade.zone}
                            </strong>
                            <span style="font-weight: 700; color: ${plColor};">
                                ${trade.profitLoss >= 0 ? '+' : ''}$${trade.profitLoss.toFixed(2)}
                            </span>
                        </div>
                        <div style="font-size: 0.85em; color: #6b7280;">
                            Entry: ${trade.entryPrice} @ $${trade.entryContractPrice}<br>
                            Exit: ${trade.exitPrice} @ $${trade.exitContractPrice}
                        </div>
                        <button onclick="removeWeeklyTrade(${index})" class="remove-zone" style="margin-top: 8px; width: auto;">Remove</button>
                    </div>
                `;
            });
            
            html = `
                <div style="background: #f0fdf4; padding: 16px; border-radius: 12px; margin-bottom: 16px; border: 2px solid #10b981;">
                    <div style="text-align: center;">
                        <div style="font-size: 0.9em; color: #065f46; font-weight: 600;">Total Weekly P&L</div>
                        <div style="font-size: 2em; font-weight: 700; color: ${totalPL >= 0 ? '#10b981' : '#ef4444'};">
                            ${totalPL >= 0 ? '+' : ''}$${totalPL.toFixed(2)}
                        </div>
                        <div style="font-size: 0.85em; color: #6b7280; margin-top: 4px;">${trades.length} trade${trades.length !== 1 ? 's' : ''}</div>
                    </div>
                </div>
            ` + html;
            
            listEl.innerHTML = html;
        }
        
        function removeWeeklyTrade(index) {
            let trades = JSON.parse(localStorage.getItem('weeklyTrades') || '[]');
            trades.splice(index, 1);
            localStorage.setItem('weeklyTrades', JSON.stringify(trades));
            displayWeeklyTrades();
            updatePatternAnalysis();
        }
        
        function updatePatternAnalysis() {
            const trades = JSON.parse(localStorage.getItem('weeklyTrades') || '[]');
            const analysisEl = document.getElementById('patternAnalysis');
            
            if (trades.length === 0) {
                analysisEl.innerHTML = '<p>Add winning trades to see pattern analysis.</p>';
                return;
            }
            
            const callTrades = trades.filter(t => t.type === 'CALL');
            const putTrades = trades.filter(t => t.type === 'PUT');
            
            const avgCallPL = callTrades.length > 0 ? 
                callTrades.reduce((sum, t) => sum + t.profitLoss, 0) / callTrades.length : 0;
            const avgPutPL = putTrades.length > 0 ? 
                putTrades.reduce((sum, t) => sum + t.profitLoss, 0) / putTrades.length : 0;
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div style="background: white; padding: 16px; border-radius: 12px;">
                        <div style="font-weight: 600; color: #10b981; margin-bottom: 8px;">üü¢ CALL Trades</div>
                        <div>Count: ${callTrades.length}</div>
                        <div>Avg P&L: $${avgCallPL.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 16px; border-radius: 12px;">
                        <div style="font-weight: 600; color: #ef4444; margin-bottom: 8px;">üî¥ PUT Trades</div>
                        <div>Count: ${putTrades.length}</div>
                        <div>Avg P&L: ${avgPutPL.toFixed(2)}</div>
                    </div>
                </div>
            `;
            
            analysisEl.innerHTML = html;
        }
        
        function saveWeeklyRecap() {
            const weekDate = document.getElementById('weekDate').value;
            const notes = document.getElementById('weeklyNotes').value;
            const trades = JSON.parse(localStorage.getItem('weeklyTrades') || '[]');
            
            if (!weekDate) {
                alert('Please select a week date');
                return;
            }
            
            const recap = {
                weekDate,
                notes,
                trades: [...trades],
                savedDate: new Date().toISOString()
            };
            
            let recaps = JSON.parse(localStorage.getItem('weeklyRecaps') || '[]');
            
            const existingIndex = recaps.findIndex(r => r.weekDate === weekDate);
            if (existingIndex >= 0) {
                recaps[existingIndex] = recap;
            } else {
                recaps.push(recap);
            }
            
            recaps.sort((a, b) => new Date(b.weekDate) - new Date(a.weekDate));
            
            localStorage.setItem('weeklyRecaps', JSON.stringify(recaps));
            localStorage.removeItem('weeklyTrades');
            
            displayWeeklyTrades();
            updatePatternAnalysis();
            displayRecapHistory();
            
            showSaveIndicator();
            alert('Weekly recap saved!');
        }
        
        function displayRecapHistory() {
            const recaps = JSON.parse(localStorage.getItem('weeklyRecaps') || '[]');
            const historyEl = document.getElementById('recapHistory');
            
            if (recaps.length === 0) {
                historyEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No saved recaps yet</p>';
                return;
            }
            
            let html = '<h3 style="margin-top: 32px; margin-bottom: 16px;">Saved Recaps</h3>';
            
            recaps.forEach((recap, index) => {
                const weekDate = new Date(recap.weekDate);
                let totalPL = 0;
                recap.trades.forEach(t => totalPL += t.profitLoss);
                const plColor = totalPL >= 0 ? '#10b981' : '#ef4444';
                
                html += `
                    <div style="background: white; padding: 20px; margin-bottom: 16px; border-radius: 12px; border: 1px solid #f0f0f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Week of ${weekDate.toLocaleDateString()}</div>
                                <div style="font-size: 0.85em; color: #6b7280;">${recap.trades.length} trade${recap.trades.length !== 1 ? 's' : ''}</div>
                            </div>
                            <div style="font-size: 1.5em; font-weight: 700; color: ${plColor};">
                                ${totalPL >= 0 ? '+' : ''}${totalPL.toFixed(2)}
                            </div>
                        </div>
                        ${recap.notes ? `
                            <div style="background: #fafafa; padding: 12px; border-radius: 8px; margin-top: 12px; font-size: 0.9em;">
                                <strong>Notes:</strong> ${recap.notes}
                            </div>
                        ` : ''}
                        <button onclick="deleteRecap(${index})" style="margin-top: 12px; background: #ef4444; padding: 8px 16px; font-size: 0.85em; width: auto;">Delete Recap</button>
                    </div>
                `;
            });
            
            historyEl.innerHTML = html;
        }
        
        function deleteRecap(index) {
            if (confirm('Delete this recap?')) {
                let recaps = JSON.parse(localStorage.getItem('weeklyRecaps') || '[]');
                recaps.splice(index, 1);
                localStorage.setItem('weeklyRecaps', JSON.stringify(recaps));
                displayRecapHistory();
                showSaveIndicator();
            }
        }
        
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
            document.getElementById(pageName + 'Page').classList.add('active');
            document.getElementById(pageName + 'Tab').classList.add('active');
        }
        
        ['trend', 'lastCandle'].forEach(id => {
            document.getElementById(id).addEventListener('change', () => {
                generateSignals();
                saveAllData();
            });
        });
        
        window.addEventListener('load', () => {
            loadSavedData();
            const today = new Date();
            const monday = new Date(today.setDate(today.getDate() - today.getDay() + 1));
            document.getElementById('weekDate').value = monday.toISOString().split('T')[0];
        });
    </script>
</body>
</html>
