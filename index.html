<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPY Swing Trading Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f4f6f8;
            color: #0d0d0d;
            min-height: 100vh;
            padding: 24px;
            line-height: 1.5;
        }
        
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #0d0d0d;
            margin-bottom: 8px;
            font-size: 2.75em;
            font-weight: 500;
            letter-spacing: -0.02em;
        }
        
        .subtitle {
            color: #6b7280;
            font-size: 1.1em;
            margin-bottom: 32px;
            font-weight: 400;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
            border: 1px solid #f0f0f0;
            transition: all 0.2s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }
        
        .card h2 {
            color: #0d0d0d;
            margin-bottom: 24px;
            font-size: 1.4em;
            font-weight: 500;
            letter-spacing: -0.01em;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 10px;
            color: #6b7280;
            font-weight: 500;
            font-size: 0.95em;
            letter-spacing: -0.01em;
        }
        
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 14px 16px;
            background: #fafafa;
            border: 1.5px solid #e5e7eb;
            border-radius: 12px;
            color: #0d0d0d;
            font-size: 1em;
            transition: all 0.15s ease;
            font-family: inherit;
        }
        
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #4f7cff;
            background: white;
            box-shadow: 0 0 0 3px rgba(79,124,255,0.08);
        }
        
        .zone-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        button {
            background: #4f7cff;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            width: 100%;
            margin-top: 10px;
            letter-spacing: -0.01em;
        }
        
        button:hover {
            background: #3d66e0;
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .signals {
            background: white;
            border-radius: 20px;
            padding: 32px;
            margin-top: 24px;
            border: 1px solid #f0f0f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }
        
        .signal-item {
            background: #fafafa;
            padding: 24px;
            margin-bottom: 16px;
            border-radius: 16px;
            border-left: 4px solid #4f7cff;
            transition: all 0.2s ease;
        }
        
        .signal-item:hover {
            background: #f5f5f5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .signal-item.call {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        
        .signal-item.put {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .signal-item.no-trade {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .signal-header {
            font-size: 1.25em;
            font-weight: 600;
            margin-bottom: 16px;
            color: #0d0d0d;
            letter-spacing: -0.02em;
        }
        
        .signal-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        
        .detail-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #f0f0f0;
        }
        
        .detail-label {
            color: #6b7280;
            font-size: 0.85em;
            font-weight: 500;
            margin-bottom: 6px;
        }
        
        .detail-value {
            color: #4f7cff;
            font-weight: 600;
            font-size: 1.2em;
            letter-spacing: -0.01em;
        }
        
        .alert-box {
            background: #fffbeb;
            border: 1.5px solid #fde68a;
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
        }
        
        .alert-box h3 {
            color: #92400e;
            margin-bottom: 16px;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .zone-list {
            max-height: 240px;
            overflow-y: auto;
            margin-top: 12px;
        }
        
        .zone-item {
            background: white;
            padding: 16px;
            margin-bottom: 10px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #f0f0f0;
            transition: all 0.15s ease;
        }
        
        .zone-item:hover {
            border-color: #e5e7eb;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }
        
        .remove-zone {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            transition: all 0.15s ease;
        }
        
        .remove-zone:hover {
            background: #dc2626;
        }
        
        .save-indicator {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 14px 20px;
            background: white;
            color: #10b981;
            border-radius: 12px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
            border: 1.5px solid #10b981;
            box-shadow: 0 4px 12px rgba(16,185,129,0.15);
            z-index: 1000;
        }
        
        .save-indicator.show {
            opacity: 1;
        }
        
        .last-updated {
            text-align: center;
            color: #6b7280;
            font-size: 0.95em;
            margin-bottom: 24px;
            font-weight: 500;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .tab-button {
            transition: all 0.15s ease;
            background: white;
            border: 1.5px solid #f0f0f0;
            color: #6b7280;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        
        .tab-button:hover {
            background: #fafafa;
            border-color: #e5e7eb;
            color: #0d0d0d;
        }
        
        .tab-button.active {
            background: #4f7cff !important;
            border-color: #4f7cff !important;
            color: white !important;
            box-shadow: 0 2px 8px rgba(79,124,255,0.25);
        }
        
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #fafafa;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #fafafa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #f0f0f0;
        }
        
        .stat-label {
            font-size: 0.85em;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 1.6em;
            font-weight: 600;
            color: #0d0d0d;
            letter-spacing: -0.01em;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <h1>SPY Swing Trading</h1>
        <p class="subtitle">Live market data powered by Polygon.io API</p>
        
        <div style="display: flex; gap: 12px; margin-bottom: 32px; flex-wrap: wrap;">
            <button onclick="showPage('dashboard')" id="dashboardTab" class="tab-button active" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; width: auto;">
                Dashboard
            </button>
            <button onclick="showPage('tradelog')" id="tradelogTab" class="tab-button" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; width: auto;">
                Trade Log
            </button>
            <button onclick="showPage('weekly')" id="weeklyTab" class="tab-button" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; width: auto;">
                Weekly Recap
            </button>
            <button onclick="showPage('backtest')" id="backtestTab" class="tab-button" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; width: auto;">
                Backtesting
            </button>
        </div>
        
        <div class="last-updated" id="lastUpdated">Loading...</div>
        
        <!-- DASHBOARD PAGE -->
        <div id="dashboardPage" class="page active">
            <!-- TradingView Chart Widget -->
            <div class="card" style="margin-bottom: 24px;">
                <h2>Live SPY Chart</h2>
                <div style="height: 500px; border-radius: 12px; overflow: hidden;">
                    <!-- TradingView Widget BEGIN -->
                    <div class="tradingview-widget-container" style="height:100%;width:100%">
                        <div class="tradingview-widget-container__widget" style="height:calc(100% - 32px);width:100%"></div>
                        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
                        {
                            "autosize": true,
                            "symbol": "AMEX:SPY",
                            "interval": "240",
                            "timezone": "America/New_York",
                            "theme": "dark",
                            "style": "1",
                            "locale": "en",
                            "backgroundColor": "rgba(0, 0, 0, 1)",
                            "hide_top_toolbar": false,
                            "hide_legend": false,
                            "allow_symbol_change": false,
                            "save_image": false,
                            "calendar": false,
                            "support_host": "https://www.tradingview.com"
                        }
                        </script>
                    </div>
                    <!-- TradingView Widget END -->
                </div>
                <p style="margin-top: 12px; font-size: 0.85em; color: #6b7280; text-align: center;">
                    4-Hour timeframe chart. Draw your zones manually on the chart or use the AI suggestions below.
                </p>
            </div>
            
            <div class="signals" id="topSignals" style="margin-bottom: 24px;">
                <h2 style="color: #0d0d0d; margin-bottom: 20px; font-weight: 600;">Trade Signals & Alerts</h2>
                <div id="signalContent">
                    <p style="text-align: center; color: #6b7280;">Connect API to generate signals...</p>
                </div>
                <div id="nextSetupContent" style="margin-top: 24px;"></div>
            </div>
            
            <div class="grid">
                <div class="card">
                    <h2>Live Market Data</h2>
                    <div class="input-group">
                        <label>Polygon.io API Key</label>
                        <div style="display: flex; gap: 12px;">
                            <input type="text" id="polygonApiKey" placeholder="Enter your API key" autocomplete="off">
                            <button onclick="connectPolygon()" style="width: auto; margin: 0; padding: 12px 20px;">Connect</button>
                        </div>
                        <div style="font-size: 0.85em; color: #6b7280; margin-top: 8px;">
                            Get your API key from <a href="https://polygon.io/dashboard/api-keys" target="_blank" style="color: #4f7cff;">Polygon.io Dashboard</a>
                        </div>
                    </div>
                    <div id="priceDisplay" style="margin-top: 12px; padding: 20px; background: #fafafa; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-size: 0.9em; color: #6b7280;">SPY Price</div>
                            <div id="connectionStatus" style="padding: 6px 12px; background: #fee2e2; color: #991b1b; border-radius: 8px; font-size: 0.85em; font-weight: 600;">
                                Disconnected
                            </div>
                        </div>
                        <div id="currentPrice" style="font-size: 2.5em; font-weight: 700; color: #0d0d0d; margin-bottom: 8px;">--</div>
                        <div id="priceChange" style="font-size: 1.1em; font-weight: 600; margin-bottom: 8px;">--</div>
                        <div id="lastUpdate" style="font-size: 0.85em; color: #6b7280;">No data</div>
                    </div>
                    <div class="input-group">
                        <label>4-Hour Trend</label>
                        <select id="trend">
                            <option value="neutral">Neutral/Sideways</option>
                            <option value="up">Uptrend</option>
                            <option value="down">Downtrend</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Last Candle (4H)</label>
                        <select id="lastCandle">
                            <option value="green">Green (Bullish)</option>
                            <option value="red">Red (Bearish)</option>
                        </select>
                    </div>
                    <button onclick="saveAllData()">Save Settings</button>
                </div>
                
                <div class="card">
                    <h2>Zone Management</h2>
                    <div class="input-group">
                        <label>Supply/Resistance Zone</label>
                        <div class="zone-inputs">
                            <input type="number" id="supplyTop" step="0.01" placeholder="Top">
                            <input type="number" id="supplyBottom" step="0.01" placeholder="Bottom">
                        </div>
                        <button onclick="addZone('supply')">Add Supply Zone</button>
                    </div>
                    <div class="input-group">
                        <label>Demand/Support Zone</label>
                        <div class="zone-inputs">
                            <input type="number" id="demandTop" step="0.01" placeholder="Top">
                            <input type="number" id="demandBottom" step="0.01" placeholder="Bottom">
                        </div>
                        <button onclick="addZone('demand')">Add Demand Zone</button>
                    </div>
                    <div class="zone-list" id="zoneList"></div>
                    <button onclick="clearAllZones()" style="background: #ef4444; margin-top: 12px;">Clear All Zones</button>
                    <button onclick="suggestZones()" style="background: #f59e0b; margin-top: 12px;">🎯 Suggest Zones (AI)</button>
                    <button onclick="loadHistoricalData()" style="background: #10b981; margin-top: 12px;">📊 Analyze Historical Performance</button>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 24px;">
                <h2>Performance Overview</h2>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Trades</div>
                        <div class="stat-value" id="totalTrades">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Win Rate</div>
                        <div class="stat-value" style="color: #10b981;" id="winRate">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total P&L</div>
                        <div class="stat-value" style="color: #4f7cff;" id="totalPL">$0</div>
                    </div>
                </div>
            </div>
            
            <div id="historicalAnalysis"></div>
            
            <div class="alert-box">
                <h3>Strategy Reminder</h3>
                <ul style="list-style: none; padding-left: 0; color: #0d0d0d;">
                    <li style="margin-bottom: 8px;">• Entry: Price enters zone + reversal candle (or 2+ hours momentum)</li>
                    <li style="margin-bottom: 8px;">• Stop Loss: Middle of zone (conservative) or opposite side (aggressive)</li>
                    <li style="margin-bottom: 8px;">• Take Profit: Next closest zone from price</li>
                    <li style="margin-bottom: 8px;">• Options: Always 7 DTE, first ITM strike</li>
                    <li>• Risk: Only 4% gap risk, plenty of time to manage trades</li>
                </ul>
            </div>
        </div>
        
        <!-- TRADE LOG PAGE -->
        <div id="tradelogPage" class="page">
            <div class="card">
                <h2>Trade Log</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Track your trades and analyze performance.</p>
                
                <div style="background: #fafafa; padding: 20px; border-radius: 16px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 16px;">Log New Trade</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div class="input-group" style="margin: 0;">
                            <label>Trade Type</label>
                            <select id="logTradeType">
                                <option value="call">CALL</option>
                                <option value="put">PUT</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Zone</label>
                            <input type="text" id="logZone" placeholder="658-663">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Entry Date/Time</label>
                            <input type="datetime-local" id="logEntryDateTime">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Entry Price</label>
                            <input type="number" id="logEntryPrice" step="0.01" placeholder="659.50">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Entry Contract Price</label>
                            <input type="number" id="logEntryContractPrice" step="0.01" placeholder="4.50">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Contracts</label>
                            <input type="number" id="logContracts" placeholder="1">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Exit Date/Time</label>
                            <input type="datetime-local" id="logExitDateTime">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Exit Price</label>
                            <input type="number" id="logExitPrice" step="0.01" placeholder="663.00">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Exit Contract Price</label>
                            <input type="number" id="logExitContractPrice" step="0.01" placeholder="7.80">
                        </div>
                    </div>
                    <button onclick="logTrade()">Log Trade</button>
                </div>
                
                <div id="tradeLogList"></div>
            </div>
        </div>
        
        <!-- BACKTESTING PAGE -->
        <div id="backtestPage" class="page">
            <div class="card">
                <h2>Strategy Backtester</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Simulate your strategy on 2 years of historical SPY data</p>
                
                <div style="background: #fef2f2; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #ef4444;">
                    <h3 style="color: #991b1b; margin-bottom: 12px;">⚠️ Critical Limitations</h3>
                    <ul style="list-style: none; padding: 0; color: #0d0d0d;">
                        <li style="margin-bottom: 8px;">• <strong>Past performance ≠ future results.</strong> Markets change constantly.</li>
                        <li style="margin-bottom: 8px;">• Uses the same logic as your live signals - if there's a flaw, backtest has it too.</li>
                        <li style="margin-bottom: 8px;">• Cannot account for: execution slippage, option pricing variations, overnight gaps.</li>
                        <li style="margin-bottom: 8px;">• Shows IF the strategy had an edge historically, NOT what will happen next.</li>
                        <li>• Zone Behavior Analysis above is more objective - just shows raw statistics.</li>
                    </ul>
                </div>
                
                <div style="background: #dbeafe; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #4f7cff;">
                    <h3 style="color: #1e40af; margin-bottom: 12px;">⚙️ Backtest Parameters</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-size: 0.85em; color: #6b7280; margin-bottom: 6px; font-weight: 500;">Stop Loss Buffer</label>
                            <select id="stopLossBuffer" style="width: 100%; padding: 10px; border: 1.5px solid #e5e7eb; border-radius: 8px; background: white;">
                                <option value="0.25">25% zone width</option>
                                <option value="0.5">50% zone width</option>
                                <option value="0.75" selected>75% zone width</option>
                                <option value="1.0">100% zone width</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.85em; color: #6b7280; margin-bottom: 6px; font-weight: 500;">Take Profit Style</label>
                            <select id="takeProfitStyle" style="width: 100%; padding: 10px; border: 1.5px solid #e5e7eb; border-radius: 8px; background: white;">
                                <option value="next_zone">Next Zone Level</option>
                                <option value="1.5R">1.5R Fixed</option>
                                <option value="2R">2R Fixed</option>
                                <option value="hybrid" selected>1.5R or 50% to Zone</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.85em; color: #6b7280; margin-bottom: 6px; font-weight: 500;">Min Confidence</label>
                            <select id="minConfidence" style="width: 100%; padding: 10px; border: 1.5px solid #e5e7eb; border-radius: 8px; background: white;">
                                <option value="50">50%+</option>
                                <option value="70">70%+</option>
                                <option value="75" selected>75%+</option>
                                <option value="80">80%+</option>
                            </select>
                        </div>
                    </div>
                    <div style="font-size: 0.85em; color: #6b7280; background: #f0f9ff; padding: 12px; border-radius: 8px;">
                        <strong>How it works:</strong> Loads 2 years of 4H data → Detects zones → Simulates trades with YOUR settings above → Shows results
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;">
                    <button onclick="runStrategyBacktest()" style="background: #4f7cff; font-size: 1.1em; padding: 16px;">
                        🎯 Run Strategy Backtest (2 Years)
                    </button>
                    <button onclick="runZoneBehaviorAnalysis()" style="background: #10b981; font-size: 1.1em; padding: 16px;">
                        📊 Analyze Zone Behavior Patterns
                    </button>
                    <button onclick="downloadBacktestResults()" style="background: #f59e0b; font-size: 1.1em; padding: 16px;">
                        📥 Download Results JSON
                    </button>
                </div>
                
                <div id="backtestResults"></div>
            </div>
        </div>
        
        <!-- WEEKLY RECAP PAGE -->
        <div id="weeklyPage" class="page">
            <div class="card">
                <h2>Weekly Recap</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Track your weekly performance and key observations.</p>
                
                <div class="input-group">
                    <label>Week Starting</label>
                    <input type="date" id="weekDate">
                </div>
                
                <div style="background: #f0fdf4; padding: 20px; border-radius: 16px; margin: 20px 0; border: 1px solid #d1fae5;">
                    <h3 style="color: #065f46; margin-bottom: 16px;">Log Winning Trades</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div class="input-group" style="margin: 0;">
                            <label>Trade Type</label>
                            <select id="weeklyTradeType">
                                <option value="CALL">CALL</option>
                                <option value="PUT">PUT</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Zone</label>
                            <input type="text" id="weeklyZone" placeholder="658-663">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Entry Date/Time</label>
                            <input type="datetime-local" id="weeklyEntryDateTime">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Entry Price</label>
                            <input type="number" id="weeklyEntryPrice" step="0.01">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Exit Date/Time</label>
                            <input type="datetime-local" id="weeklyExitDateTime">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Exit Price</label>
                            <input type="number" id="weeklyExitPrice" step="0.01">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Entry Contract Price</label>
                            <input type="number" id="weeklyEntryContractPrice" step="0.01">
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Exit Contract Price</label>
                            <input type="number" id="weeklyExitContractPrice" step="0.01">
                        </div>
                    </div>
                    <button onclick="addWeeklyTrade()" style="background: #10b981;">Add Trade</button>
                    <div id="weeklyTradesList" style="margin-top: 16px;"></div>
                </div>
                
                <div style="background: #fffbeb; padding: 20px; border-radius: 16px; margin: 20px 0; border: 1px solid #fef3c7;">
                    <h3 style="color: #92400e; margin-bottom: 16px;">Pattern Analysis</h3>
                    <div id="patternAnalysis">
                        <p>Add winning trades to see pattern analysis.</p>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Key Observations</label>
                    <textarea id="weeklyNotes" style="min-height: 100px;" placeholder="Enter key observations from your instructor..."></textarea>
                </div>
                
                <button onclick="saveWeeklyRecap()">Save Recap</button>
                
                <div id="recapHistory" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>
    
    <div class="save-indicator" id="saveIndicator">✓ Saved</div>
    
    <script>
        let zones = { supply: [], demand: [] };
        let polygonApiKey = '';
        let currentPrice = 0;
        let priceHistory = [];
        let updateInterval = null;
        let zoneAlertChecked = {};
        
        async function connectPolygon() {
            const apiKey = document.getElementById('polygonApiKey').value.trim();
            if (!apiKey) {
                alert('Please enter your Polygon.io API key');
                return;
            }
            
            polygonApiKey = apiKey;
            localStorage.setItem('polygonApiKey', apiKey);
            
            try {
                await updateLivePrice();
                document.getElementById('connectionStatus').style.background = '#d1fae5';
                document.getElementById('connectionStatus').style.color = '#065f46';
                document.getElementById('connectionStatus').textContent = 'Connected ✓';
                
                if (updateInterval) clearInterval(updateInterval);
                updateInterval = setInterval(updateLivePrice, 15000);
                
                showSaveIndicator();
            } catch (error) {
                alert('Connection failed: ' + error.message);
            }
        }
        
        async function updateLivePrice() {
            if (!polygonApiKey) return;
            
            try {
                // Use snapshot endpoint - works with Starter plan
                const response = await fetch(
                    `https://api.polygon.io/v2/snapshot/locale/us/markets/stocks/tickers/SPY?apiKey=${polygonApiKey}`
                );
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'OK' && data.ticker) {
                    const ticker = data.ticker;
                    const lastPrice = ticker.day?.c || ticker.lastTrade?.p || ticker.prevDay?.c;
                    const prevClose = ticker.prevDay?.c || lastPrice;
                    
                    if (!lastPrice) {
                        throw new Error('No price data available');
                    }
                    
                    const change = lastPrice - prevClose;
                    const changePercent = prevClose ? (change / prevClose) * 100 : 0;
                    
                    currentPrice = lastPrice;
                    
                    document.getElementById('currentPrice').textContent = lastPrice.toFixed(2);
                    
                    const priceChangeEl = document.getElementById('priceChange');
                    const changeSign = change >= 0 ? '+' : '';
                    priceChangeEl.textContent = `${changeSign}${change.toFixed(2)} (${changeSign}${changePercent.toFixed(2)}%)`;
                    priceChangeEl.style.color = change >= 0 ? '#10b981' : '#ef4444';
                    
                    const updateTime = ticker.updated ? new Date(ticker.updated) : new Date();
                    document.getElementById('lastUpdate').textContent = 
                        `Updated: ${updateTime.toLocaleTimeString()} (15-min delay)`;
                    
                    priceHistory.push({ price: lastPrice, timestamp: Date.now() });
                    if (priceHistory.length > 100) priceHistory.shift();
                    
                    checkZoneAlerts(lastPrice);
                    generateSignals();
                    
                    localStorage.setItem('lastLivePrice', JSON.stringify({
                        price: lastPrice,
                        timestamp: Date.now()
                    }));
                } else {
                    throw new Error('Invalid response from API');
                }
            } catch (error) {
                console.error('Price update failed:', error);
                document.getElementById('lastUpdate').textContent = 'Update failed: ' + error.message;
            }
        }
        
        function checkZoneAlerts(price) {
            zones.supply.forEach((zone, index) => {
                const zoneKey = `supply_${index}`;
                const isInZone = price >= zone.bottom && price <= zone.top;
                
                if (isInZone && !zoneAlertChecked[zoneKey]) {
                    zoneAlertChecked[zoneKey] = true;
                    showAlert(`🔴 PUT Setup: Price entered supply zone ${zone.bottom.toFixed(2)}-${zone.top.toFixed(2)}`);
                } else if (!isInZone) {
                    zoneAlertChecked[zoneKey] = false;
                }
            });
            
            zones.demand.forEach((zone, index) => {
                const zoneKey = `demand_${index}`;
                const isInZone = price >= zone.bottom && price <= zone.top;
                
                if (isInZone && !zoneAlertChecked[zoneKey]) {
                    zoneAlertChecked[zoneKey] = true;
                    showAlert(`🟢 CALL Setup: Price entered demand zone ${zone.bottom.toFixed(2)}-${zone.top.toFixed(2)}`);
                } else if (!isInZone) {
                    zoneAlertChecked[zoneKey] = false;
                }
            });
        }
        
        function showAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = 'position: fixed; top: 80px; right: 24px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-left: 4px solid #4f7cff; max-width: 400px; z-index: 2000;';
            alertDiv.innerHTML = `<div style="font-weight: 600; margin-bottom: 8px;">${message}</div><div style="font-size: 0.85em; color: #6b7280;">Look for reversal candle confirmation</div>`;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => alertDiv.remove(), 8000);
        }
        
        async function suggestZones() {
            if (!polygonApiKey) {
                alert('Please connect to Polygon.io first');
                return;
            }
            
            const loadingDiv = document.getElementById('historicalAnalysis');
            loadingDiv.innerHTML = '<div class="card"><h2>🎯 Analyzing Market Data...</h2><p style="color: #6b7280;">Using AI to detect supply and demand zones based on 90 days of 4-hour price action...</p></div>';
            
            try {
                // Get 90 days of 4-hour data (240 minute bars)
                const to = new Date();
                const from = new Date();
                from.setDate(from.getDate() - 90);
                
                const fromStr = from.toISOString().split('T')[0];
                const toStr = to.toISOString().split('T')[0];
                
                const response = await fetch(
                    `https://api.polygon.io/v2/aggs/ticker/SPY/range/240/minute/${fromStr}/${toStr}?adjusted=true&sort=asc&limit=5000&apiKey=${polygonApiKey}`
                );
                
                if (!response.ok) {
                    throw new Error('Failed to load data');
                }
                
                const data = await response.json();
                
                if (!data.results || data.results.length === 0) {
                    throw new Error('No data available');
                }
                
                const candles = data.results;
                const detectedZones = detectZones(candles);
                
                displaySuggestedZones(detectedZones);
                
            } catch (error) {
                loadingDiv.innerHTML = `<div class="card"><h2>Error</h2><p style="color: #ef4444;">${error.message}</p></div>`;
            }
        }
        
        function detectZones(candles) {
            const supplyZones = [];
            const demandZones = [];
            const zoneWidth = 3; // 3 point zone width
            const minZoneDistance = 5; // Minimum 5 points between zones
            
            // Find swing highs (potential supply zones)
            for (let i = 2; i < candles.length - 2; i++) {
                const current = candles[i];
                const prev1 = candles[i - 1];
                const prev2 = candles[i - 2];
                const next1 = candles[i + 1];
                const next2 = candles[i + 2];
                
                // Swing high: current high is higher than surrounding candles
                if (current.h > prev1.h && current.h > prev2.h && 
                    current.h > next1.h && current.h > next2.h) {
                    
                    const zoneTop = current.h;
                    const zoneBottom = current.h - zoneWidth;
                    
                    // Count how many times this zone was tested
                    let tests = 0;
                    let bounces = 0;
                    
                    for (let j = i + 1; j < candles.length; j++) {
                        const testCandle = candles[j];
                        
                        // Price entered zone
                        if (testCandle.h >= zoneBottom && testCandle.l <= zoneTop) {
                            tests++;
                            
                            // Bearish reversal (close lower than open)
                            if (testCandle.c < testCandle.o) {
                                bounces++;
                            }
                        }
                    }
                    
                    // Calculate recency score (more recent = higher score)
                    const recencyScore = i / candles.length;
                    
                    // Calculate confidence (tests, bounces, recency)
                    const confidence = ((bounces / (tests + 1)) * 50) + (tests * 10) + (recencyScore * 40);
                    
                    supplyZones.push({
                        top: zoneTop,
                        bottom: zoneBottom,
                        tests: tests,
                        bounces: bounces,
                        confidence: Math.min(confidence, 100),
                        index: i,
                        date: new Date(candles[i].t).toLocaleDateString()
                    });
                }
            }
            
            // Find swing lows (potential demand zones)
            for (let i = 2; i < candles.length - 2; i++) {
                const current = candles[i];
                const prev1 = candles[i - 1];
                const prev2 = candles[i - 2];
                const next1 = candles[i + 1];
                const next2 = candles[i + 2];
                
                // Swing low: current low is lower than surrounding candles
                if (current.l < prev1.l && current.l < prev2.l && 
                    current.l < next1.l && current.l < next2.l) {
                    
                    const zoneBottom = current.l;
                    const zoneTop = current.l + zoneWidth;
                    
                    // Count how many times this zone was tested
                    let tests = 0;
                    let bounces = 0;
                    
                    for (let j = i + 1; j < candles.length; j++) {
                        const testCandle = candles[j];
                        
                        // Price entered zone
                        if (testCandle.l <= zoneTop && testCandle.h >= zoneBottom) {
                            tests++;
                            
                            // Bullish reversal (close higher than open)
                            if (testCandle.c > testCandle.o) {
                                bounces++;
                            }
                        }
                    }
                    
                    // Calculate recency score
                    const recencyScore = i / candles.length;
                    
                    // Calculate confidence
                    const confidence = ((bounces / (tests + 1)) * 50) + (tests * 10) + (recencyScore * 40);
                    
                    demandZones.push({
                        top: zoneTop,
                        bottom: zoneBottom,
                        tests: tests,
                        bounces: bounces,
                        confidence: Math.min(confidence, 100),
                        index: i,
                        date: new Date(candles[i].t).toLocaleDateString()
                    });
                }
            }
            
            // Sort by confidence
            supplyZones.sort((a, b) => b.confidence - a.confidence);
            demandZones.sort((a, b) => b.confidence - a.confidence);
            
            // Filter out zones too close together
            const filteredSupply = filterCloseZones(supplyZones, minZoneDistance);
            const filteredDemand = filterCloseZones(demandZones, minZoneDistance);
            
            // Take top 4 of each
            return {
                supply: filteredSupply.slice(0, 4),
                demand: filteredDemand.slice(0, 4)
            };
        }
        
        function filterCloseZones(zones, minDistance) {
            const filtered = [];
            
            for (let i = 0; i < zones.length; i++) {
                const zone = zones[i];
                let tooClose = false;
                
                for (let j = 0; j < filtered.length; j++) {
                    const existing = filtered[j];
                    const distance = Math.abs(zone.bottom - existing.bottom);
                    
                    if (distance < minDistance) {
                        tooClose = true;
                        break;
                    }
                }
                
                if (!tooClose) {
                    filtered.push(zone);
                }
            }
            
            return filtered;
        }
        
        function displaySuggestedZones(detectedZones) {
            let html = '<div class="card" style="margin-top: 24px;"><h2>🎯 AI-Suggested Zones</h2>';
            html += '<p style="color: #6b7280; margin-bottom: 20px;">Based on 90 days of price action analysis. Click "Add" to use these zones.</p>';
            
            if (detectedZones.supply.length > 0) {
                html += '<h3 style="color: #ef4444; margin-top: 16px; margin-bottom: 12px;">🔴 Suggested Supply Zones (Resistance)</h3>';
                
                detectedZones.supply.forEach((zone, index) => {
                    const quality = zone.confidence >= 70 ? '🔥 Strong' : zone.confidence >= 50 ? '✓ Good' : '⚠️ Moderate';
                    const qualityColor = zone.confidence >= 70 ? '#10b981' : zone.confidence >= 50 ? '#f59e0b' : '#6b7280';
                    
                    html += `
                        <div style="background: #fafafa; padding: 20px; margin-bottom: 12px; border-radius: 12px; border-left: 4px solid #ef4444;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div>
                                    <div style="font-weight: 600; color: #0d0d0d; margin-bottom: 4px;">
                                        Zone: ${zone.top.toFixed(2)} - ${zone.bottom.toFixed(2)}
                                    </div>
                                    <div style="font-size: 0.85em; color: #6b7280;">Formed: ${zone.date}</div>
                                </div>
                                <div style="font-weight: 600; color: ${qualityColor};">${quality}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 12px;">
                                <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.8em; color: #6b7280;">Confidence</div>
                                    <div style="font-weight: 600; color: #4f7cff; font-size: 1.2em;">${zone.confidence.toFixed(0)}%</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.8em; color: #6b7280;">Tests</div>
                                    <div style="font-weight: 600; font-size: 1.2em;">${zone.tests}</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.8em; color: #6b7280;">Bounces</div>
                                    <div style="font-weight: 600; font-size: 1.2em;">${zone.bounces}</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.8em; color: #6b7280;">Success</div>
                                    <div style="font-weight: 600; color: #10b981; font-size: 1.2em;">
                                        ${zone.tests > 0 ? ((zone.bounces / zone.tests) * 100).toFixed(0) : 0}%
                                    </div>
                                </div>
                            </div>
                            <button onclick="addSuggestedZone('supply', ${zone.top}, ${zone.bottom})" 
                                    style="background: #10b981; padding: 10px 20px; width: auto; margin: 0;">
                                ✓ Add This Zone
                            </button>
                        </div>
                    `;
                });
            }
            
            if (detectedZones.demand.length > 0) {
                html += '<h3 style="color: #10b981; margin-top: 24px; margin-bottom: 12px;">🟢 Suggested Demand Zones (Support)</h3>';
                
                detectedZones.demand.forEach((zone, index) => {
                    const quality = zone.confidence >= 70 ? '🔥 Strong' : zone.confidence >= 50 ? '✓ Good' : '⚠️ Moderate';
                    const qualityColor = zone.confidence >= 70 ? '#10b981' : zone.confidence >= 50 ? '#f59e0b' : '#6b7280';
                    
                    html += `
                        <div style="background: #fafafa; padding: 20px; margin-bottom: 12px; border-radius: 12px; border-left: 4px solid #10b981;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div>
                                    <div style="font-weight: 600; color: #0d0d0d; margin-bottom: 4px;">
                                        Zone: ${zone.top.toFixed(2)} - ${zone.bottom.toFixed(2)}
                                    </div>
                                    <div style="font-size: 0.85em; color: #6b7280;">Formed: ${zone.date}</div>
                                </div>
                                <div style="font-weight: 600; color: ${qualityColor};">${quality}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 12px;">
                                <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.8em; color: #6b7280;">Confidence</div>
                                    <div style="font-weight: 600; color: #4f7cff; font-size: 1.2em;">${zone.confidence.toFixed(0)}%</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.8em; color: #6b7280;">Tests</div>
                                    <div style="font-weight: 600; font-size: 1.2em;">${zone.tests}</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.8em; color: #6b7280;">Bounces</div>
                                    <div style="font-weight: 600; font-size: 1.2em;">${zone.bounces}</div>
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.8em; color: #6b7280;">Success</div>
                                    <div style="font-weight: 600; color: #10b981; font-size: 1.2em;">
                                        ${zone.tests > 0 ? ((zone.bounces / zone.tests) * 100).toFixed(0) : 0}%
                                    </div>
                                </div>
                            </div>
                            <button onclick="addSuggestedZone('demand', ${zone.top}, ${zone.bottom})" 
                                    style="background: #10b981; padding: 10px 20px; width: auto; margin: 0;">
                                ✓ Add This Zone
                            </button>
                        </div>
                    `;
                });
            }
            
            html += '<div style="background: #fffbeb; padding: 16px; border-radius: 12px; margin-top: 20px; border: 1px solid #fef3c7;">';
            html += '<div style="font-weight: 600; color: #92400e; margin-bottom: 8px;">💡 How AI Zones Work</div>';
            html += '<div style="font-size: 0.9em; color: #0d0d0d;">';
            html += '<p style="margin-bottom: 8px;">• Analyzes 90 days of daily price action</p>';
            html += '<p style="margin-bottom: 8px;">• Identifies swing highs/lows where price reversed</p>';
            html += '<p style="margin-bottom: 8px;">• Tests zones against future price movement</p>';
            html += '<p style="margin-bottom: 8px;">• Ranks by confidence: tests + bounces + recency</p>';
            html += '<p style="color: #ef4444; font-weight: 500;">⚠️ Note: Zones can FLIP when broken - Old supply becomes new demand & vice versa</p>';
            html += '</div></div>';
            
            html += '<div style="margin-top: 16px; text-align: center;">';
            html += '<button onclick="addAllSuggestedZones()" style="background: #4f7cff; width: auto; padding: 12px 24px;">Add All Strong Zones (70%+)</button>';
            html += '</div>';
            
            html += '</div>';
            
            document.getElementById('historicalAnalysis').innerHTML = html;
            
            // Store for batch add
            window.suggestedZonesData = detectedZones;
        }
        
        function addSuggestedZone(type, top, bottom) {
            zones[type].push({ top: top, bottom: bottom });
            updateZoneList();
            generateSignals();
            saveAllData();
            showSaveIndicator();
            alert(`${type.toUpperCase()} zone added: ${bottom.toFixed(2)} - ${top.toFixed(2)}`);
        }
        
        function addAllSuggestedZones() {
            if (!window.suggestedZonesData) {
                alert('No suggested zones available');
                return;
            }
            
            let added = 0;
            
            // Add supply zones with 70%+ confidence
            window.suggestedZonesData.supply.forEach(zone => {
                if (zone.confidence >= 70) {
                    zones.supply.push({ top: zone.top, bottom: zone.bottom });
                    added++;
                }
            });
            
            // Add demand zones with 70%+ confidence
            window.suggestedZonesData.demand.forEach(zone => {
                if (zone.confidence >= 70) {
                    zones.demand.push({ top: zone.top, bottom: zone.bottom });
                    added++;
                }
            });
            
            updateZoneList();
            generateSignals();
            saveAllData();
            showSaveIndicator();
            
            alert(`Added ${added} high-confidence zones to your dashboard!`);
        }
        
        async function loadHistoricalData() {
            if (!polygonApiKey) {
                alert('Please connect to Polygon.io first');
                return;
            }
            
            if (zones.supply.length === 0 && zones.demand.length === 0) {
                alert('Please add some zones first');
                return;
            }
            
            const analysisDiv = document.getElementById('historicalAnalysis');
            analysisDiv.innerHTML = '<div class="card"><h2>Loading Historical Data...</h2><p style="color: #6b7280;">Fetching 5 years of 4-hour SPY data from Polygon.io...</p></div>';
            
            try {
                const to = new Date();
                const from = new Date();
                from.setFullYear(from.getFullYear() - 5);
                
                const fromStr = from.toISOString().split('T')[0];
                const toStr = to.toISOString().split('T')[0];
                
                const response = await fetch(
                    `https://api.polygon.io/v2/aggs/ticker/SPY/range/240/minute/${fromStr}/${toStr}?adjusted=true&sort=asc&limit=50000&apiKey=${polygonApiKey}`
                );
                
                if (!response.ok) {
                    throw new Error('Failed to load historical data');
                }
                
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    analyzeHistoricalZones(data.results);
                } else {
                    alert('No historical data available');
                }
            } catch (error) {
                analysisDiv.innerHTML = `<div class="card"><h2>Error Loading Data</h2><p style="color: #ef4444;">${error.message}</p></div>`;
            }
        }
        
        function analyzeHistoricalZones(historicalData) {
            const analysis = {
                supplyZoneTests: [],
                demandZoneTests: []
            };
            
            zones.supply.forEach((zone) => {
                let tests = 0;
                let bounces = 0;
                
                for (let i = 1; i < historicalData.length; i++) {
                    const candle = historicalData[i];
                    
                    if (candle.h >= zone.bottom && candle.l <= zone.top) {
                        tests++;
                        if (candle.c < candle.o) bounces++;
                    }
                }
                
                analysis.supplyZoneTests.push({
                    zone: zone,
                    tests: tests,
                    bounces: bounces,
                    successRate: tests > 0 ? (bounces / tests * 100).toFixed(1) : 0
                });
            });
            
            zones.demand.forEach((zone) => {
                let tests = 0;
                let bounces = 0;
                
                for (let i = 1; i < historicalData.length; i++) {
                    const candle = historicalData[i];
                    
                    if (candle.l <= zone.top && candle.h >= zone.bottom) {
                        tests++;
                        if (candle.c > candle.o) bounces++;
                    }
                }
                
                analysis.demandZoneTests.push({
                    zone: zone,
                    tests: tests,
                    bounces: bounces,
                    successRate: tests > 0 ? (bounces / tests * 100).toFixed(1) : 0
                });
            });
            
            displayZoneAnalysis(analysis, historicalData.length);
        }
        
        function displayZoneAnalysis(analysis, totalDays) {
            let html = '<div class="card" style="margin-top: 24px;"><h2>📊 Historical Zone Performance (5 Years)</h2>';
            html += `<p style="color: #6b7280; margin-bottom: 20px;">Analyzed ${totalDays} trading days</p>`;
            
            if (analysis.supplyZoneTests.length > 0) {
                html += '<h3 style="color: #ef4444; margin-top: 16px; margin-bottom: 12px;">🔴 Supply Zones</h3>';
                analysis.supplyZoneTests.forEach(test => {
                    const quality = test.successRate >= 70 ? '🔥 Strong' : test.successRate >= 50 ? '✓ Good' : '⚠️ Weak';
                    html += `
                        <div style="background: #fafafa; padding: 20px; margin-bottom: 12px; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-weight: 600; color: #0d0d0d;">Zone: ${test.zone.bottom.toFixed(2)} - ${test.zone.top.toFixed(2)}</div>
                                <div style="font-weight: 600; color: ${test.successRate >= 70 ? '#10b981' : test.successRate >= 50 ? '#f59e0b' : '#ef4444'};">${quality}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                <div style="background: white; padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.85em; color: #6b7280;">Tests</div>
                                    <div style="font-weight: 600; color: #0d0d0d; font-size: 1.3em;">${test.tests}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.85em; color: #6b7280;">Bounces</div>
                                    <div style="font-weight: 600; color: #0d0d0d; font-size: 1.3em;">${test.bounces}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.85em; color: #6b7280;">Success Rate</div>
                                    <div style="font-weight: 600; color: #10b981; font-size: 1.3em;">${test.successRate}%</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            if (analysis.demandZoneTests.length > 0) {
                html += '<h3 style="color: #10b981; margin-top: 24px; margin-bottom: 12px;">🟢 Demand Zones</h3>';
                analysis.demandZoneTests.forEach(test => {
                    const quality = test.successRate >= 70 ? '🔥 Strong' : test.successRate >= 50 ? '✓ Good' : '⚠️ Weak';
                    html += `
                        <div style="background: #fafafa; padding: 20px; margin-bottom: 12px; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-weight: 600; color: #0d0d0d;">Zone: ${test.zone.bottom.toFixed(2)} - ${test.zone.top.toFixed(2)}</div>
                                <div style="font-weight: 600; color: ${test.successRate >= 70 ? '#10b981' : test.successRate >= 50 ? '#f59e0b' : '#ef4444'};">${quality}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                <div style="background: white; padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.85em; color: #6b7280;">Tests</div>
                                    <div style="font-weight: 600; color: #0d0d0d; font-size: 1.3em;">${test.tests}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.85em; color: #6b7280;">Bounces</div>
                                    <div style="font-weight: 600; color: #0d0d0d; font-size: 1.3em;">${test.bounces}</div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 0.85em; color: #6b7280;">Success Rate</div>
                                    <div style="font-weight: 600; color: #10b981; font-size: 1.3em;">${test.successRate}%</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            
            document.getElementById('historicalAnalysis').innerHTML = html;
        }
        
        function loadSavedData() {
            try {
                const savedZones = localStorage.getItem('tradingZones');
                if (savedZones) zones = JSON.parse(savedZones);
                
                const savedApiKey = localStorage.getItem('polygonApiKey');
                if (savedApiKey) {
                    document.getElementById('polygonApiKey').value = savedApiKey;
                    polygonApiKey = savedApiKey;
                    setTimeout(() => connectPolygon(), 1000);
                }
                
                const savedMarketData = localStorage.getItem('marketData');
                if (savedMarketData) {
                    const data = JSON.parse(savedMarketData);
                    document.getElementById('trend').value = data.trend || 'neutral';
                    document.getElementById('lastCandle').value = data.lastCandle || 'green';
                }
                
                const lastSaved = localStorage.getItem('lastSaved');
                document.getElementById('lastUpdated').textContent = lastSaved ? 
                    `Last updated ${new Date(lastSaved).toLocaleString()}` : 'No saved data';
                
                updateZoneList();
                generateSignals();
                updateStats();
                displayWeeklyTrades();
                updatePatternAnalysis();
                displayRecapHistory();
                displayTradeLogs();
            } catch (error) {
                console.error('Error loading:', error);
            }
        }
        
        function saveAllData() {
            try {
                localStorage.setItem('tradingZones', JSON.stringify(zones));
                localStorage.setItem('marketData', JSON.stringify({
                    trend: document.getElementById('trend').value,
                    lastCandle: document.getElementById('lastCandle').value,
                    timestamp: new Date().toISOString()
                }));
                localStorage.setItem('lastSaved', new Date().toISOString());
                showSaveIndicator();
                document.getElementById('lastUpdated').textContent = 
                    `Last updated ${new Date().toLocaleString()}`;
            } catch (error) {
                alert('Error saving data');
            }
        }
        
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }
        
        function addZone(type) {
            const topInput = type === 'supply' ? 'supplyTop' : 'demandTop';
            const bottomInput = type === 'supply' ? 'supplyBottom' : 'demandBottom';
            const top = parseFloat(document.getElementById(topInput).value);
            const bottom = parseFloat(document.getElementById(bottomInput).value);
            
            if (top && bottom && top > bottom) {
                zones[type].push({ top, bottom });
                updateZoneList();
                document.getElementById(topInput).value = '';
                document.getElementById(bottomInput).value = '';
                generateSignals();
                saveAllData();
            } else {
                alert('Please enter valid zone values (top must be > bottom)');
            }
        }
        
        function removeZone(type, index) {
            zones[type].splice(index, 1);
            updateZoneList();
            generateSignals();
            saveAllData();
        }
        
        function clearAllZones() {
            if (confirm('Clear all zones?')) {
                zones.supply = [];
                zones.demand = [];
                updateZoneList();
                generateSignals();
                saveAllData();
            }
        }
        
        function updateZoneList() {
            const list = document.getElementById('zoneList');
            let html = '';
            
            zones.supply.forEach((zone, i) => {
                html += `<div class="zone-item">
                    <span style="color: #0d0d0d; font-weight: 500;">🔴 Supply: ${zone.top.toFixed(2)} - ${zone.bottom.toFixed(2)}</span>
                    <button class="remove-zone" onclick="removeZone('supply', ${i})">Remove</button>
                </div>`;
            });
            
            zones.demand.forEach((zone, i) => {
                html += `<div class="zone-item">
                    <span style="color: #0d0d0d; font-weight: 500;">🟢 Demand: ${zone.top.toFixed(2)} - ${zone.bottom.toFixed(2)}</span>
                    <button class="remove-zone" onclick="removeZone('demand', ${i})">Remove</button>
                </div>`;
            });
            
            list.innerHTML = html || '<p style="color: #6b7280; text-align: center; padding: 12px;">No zones added</p>';
        }
        
        function generateSignals() {
            const price = currentPrice || 0;
            const trend = document.getElementById('trend').value;
            const lastCandle = document.getElementById('lastCandle').value;
            
            if (!price) {
                document.getElementById('signalContent').innerHTML = 
                    '<p style="text-align: center; color: #6b7280;">Waiting for live price data...</p>';
                return;
            }
            
            let signals = [];
            let nearbyZones = [];
            
            // Check if price is IN a zone (active signal)
            zones.supply.forEach(zone => {
                if (price >= zone.bottom && price <= zone.top) {
                    // Calculate confidence based on conditions
                    let confidence = 50; // Base confidence
                    
                    // Trend alignment
                    if (trend === 'down') confidence += 20;
                    if (trend === 'up') confidence -= 15;
                    
                    // Candle confirmation
                    if (lastCandle === 'red') confidence += 20;
                    else confidence -= 10;
                    
                    // Price position in zone (closer to top = better for puts)
                    const zoneHeight = zone.top - zone.bottom;
                    const pricePosition = (price - zone.bottom) / zoneHeight;
                    if (pricePosition > 0.7) confidence += 10; // Near top of zone
                    
                    confidence = Math.max(0, Math.min(100, confidence));
                    
                    signals.push({
                        type: 'put',
                        zone: zone,
                        entry: price,
                        condition: lastCandle === 'red' ? 'Strong - Reversal Candle Present' : 'Weak - Wait for Red Candle',
                        stopLoss: zone.top + ((zone.top - zone.bottom) * 0.5),
                        takeProfit: findNextZone('down', price),
                        takeProfitPrice: findNextZonePrice('down', price),
                        trend: trend === 'down' ? 'With Trend' : trend === 'up' ? 'Against Trend' : 'Neutral',
                        confidence: confidence,
                        recommendation: confidence >= 70 ? 'STRONG SIGNAL' : confidence >= 50 ? 'MODERATE SIGNAL' : 'WEAK SIGNAL'
                    });
                }
            });
            
            zones.demand.forEach(zone => {
                if (price >= zone.bottom && price <= zone.top) {
                    let confidence = 50;
                    
                    if (trend === 'up') confidence += 20;
                    if (trend === 'down') confidence -= 15;
                    
                    if (lastCandle === 'green') confidence += 20;
                    else confidence -= 10;
                    
                    // Price position (closer to bottom = better for calls)
                    const zoneHeight = zone.top - zone.bottom;
                    const pricePosition = (price - zone.bottom) / zoneHeight;
                    if (pricePosition < 0.3) confidence += 10;
                    
                    confidence = Math.max(0, Math.min(100, confidence));
                    
                    signals.push({
                        type: 'call',
                        zone: zone,
                        entry: price,
                        condition: lastCandle === 'green' ? 'Strong - Reversal Candle Present' : 'Weak - Wait for Green Candle',
                        stopLoss: zone.bottom - ((zone.top - zone.bottom) * 0.5),
                        takeProfit: findNextZone('up', price),
                        takeProfitPrice: findNextZonePrice('up', price),
                        trend: trend === 'up' ? 'With Trend' : trend === 'down' ? 'Against Trend' : 'Neutral',
                        confidence: confidence,
                        recommendation: confidence >= 70 ? 'STRONG SIGNAL' : confidence >= 50 ? 'MODERATE SIGNAL' : 'WEAK SIGNAL'
                    });
                }
            });
            
            // Find nearby zones (within 15 points)
            zones.supply.forEach(zone => {
                const distance = zone.bottom - price;
                if (distance > 0 && distance <= 15) {
                    nearbyZones.push({
                        type: 'supply',
                        zone: zone,
                        distance: distance,
                        direction: 'above'
                    });
                }
            });
            
            zones.demand.forEach(zone => {
                const distance = price - zone.top;
                if (distance > 0 && distance <= 15) {
                    nearbyZones.push({
                        type: 'demand',
                        zone: zone,
                        distance: distance,
                        direction: 'below'
                    });
                }
            });
            
            // Sort nearby zones by distance
            nearbyZones.sort((a, b) => a.distance - b.distance);
            
            displaySignals(signals, nearbyZones, price);
        }
        
        function findNextZonePrice(direction, currentPrice) {
            let targetZone = null;
            
            if (direction === 'up') {
                zones.supply.forEach(zone => {
                    if (zone.bottom > currentPrice) {
                        if (!targetZone || zone.bottom < targetZone.bottom) {
                            targetZone = zone;
                        }
                    }
                });
                return targetZone ? targetZone.bottom : null;
            } else {
                zones.demand.forEach(zone => {
                    if (zone.top < currentPrice) {
                        if (!targetZone || zone.top > targetZone.top) {
                            targetZone = zone;
                        }
                    }
                });
                return targetZone ? targetZone.top : null;
            }
        }
        
        function displaySignals(signals, nearbyZones, price) {
            let html = '';
            
            // Active signals
            if (signals.length === 0) {
                html = `<div class="signal-item no-trade">
                    <div class="signal-header">⚠️ No Active Signals</div>
                    <p style="color: #0d0d0d; margin-bottom: 16px; font-weight: 500;">
                        Current Price: <strong>${price.toFixed(2)}</strong> - Not in any trade zones
                    </p>
                    <p style="color: #6b7280; margin-bottom: 8px;">Wait for price to enter a zone + reversal candle confirmation before taking a trade.</p>
                </div>`;
            } else {
                signals.forEach(signal => {
                    const className = signal.type === 'call' ? 'call' : 'put';
                    const emoji = signal.type === 'call' ? '🟢' : '🔴';
                    const confidenceColor = signal.confidence >= 70 ? '#10b981' : signal.confidence >= 50 ? '#f59e0b' : '#ef4444';
                    const riskReward = signal.takeProfitPrice ? 
                        ((Math.abs(signal.takeProfitPrice - signal.entry) / Math.abs(signal.stopLoss - signal.entry))).toFixed(2) : 'N/A';
                    
                    html += `<div class="signal-item ${className}" style="border-left-width: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div class="signal-header" style="margin: 0;">${emoji} ${signal.recommendation}</div>
                            <div style="background: ${confidenceColor}; color: white; padding: 8px 16px; border-radius: 8px; font-weight: 700; font-size: 1.1em;">
                                ${signal.confidence}% CONFIDENCE
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                            <div style="font-weight: 600; color: #0d0d0d; margin-bottom: 12px; font-size: 1.1em;">Trade Setup:</div>
                            <div style="display: grid; gap: 8px; color: #0d0d0d;">
                                <div>• <strong>Type:</strong> ${signal.type.toUpperCase()} Options (7 DTE, First ITM Strike)</div>
                                <div>• <strong>Zone:</strong> ${signal.zone.bottom.toFixed(2)} - ${signal.zone.top.toFixed(2)}</div>
                                <div>• <strong>Trend:</strong> ${signal.trend} ${signal.trend === 'With Trend' ? '✓' : signal.trend === 'Against Trend' ? '⚠️' : ''}</div>
                                <div>• <strong>Candle Status:</strong> ${signal.condition}</div>
                            </div>
                        </div>
                        
                        <div class="signal-details" style="grid-template-columns: repeat(4, 1fr);">
                            <div class="detail-item">
                                <div class="detail-label">Entry Price</div>
                                <div class="detail-value" style="color: #4f7cff;">${signal.entry.toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Stop Loss</div>
                                <div class="detail-value" style="color: #ef4444;">${signal.stopLoss.toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Take Profit</div>
                                <div class="detail-value" style="color: #10b981;">
                                    ${signal.takeProfitPrice ? signal.takeProfitPrice.toFixed(2) : 'No zone'}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Risk:Reward</div>
                                <div class="detail-value" style="color: #10b981;">1:${riskReward}</div>
                            </div>
                        </div>
                        
                        ${signal.confidence < 70 ? `
                            <div style="background: #fffbeb; padding: 12px; border-radius: 8px; margin-top: 16px; border: 1px solid #fef3c7;">
                                <div style="font-weight: 600; color: #92400e; margin-bottom: 4px;">⚠️ Caution</div>
                                <div style="font-size: 0.9em; color: #0d0d0d;">
                                    ${signal.confidence < 50 ? 'Low confidence - Consider waiting for better setup' : 'Moderate confidence - Ensure strict risk management'}
                                </div>
                            </div>
                        ` : ''}
                    </div>`;
                });
            }
            
            // Nearby zones to watch
            if (nearbyZones.length > 0) {
                html += '<div style="background: #dbeafe; padding: 20px; border-radius: 16px; margin-top: 16px; border-left: 4px solid #4f7cff;">';
                html += '<div style="font-weight: 600; color: #1e40af; margin-bottom: 12px; font-size: 1.1em;">📍 Zones to Watch</div>';
                html += '<div style="color: #0d0d0d;">';
                
                nearbyZones.slice(0, 3).forEach(nz => {
                    const zoneType = nz.type === 'supply' ? 'PUT' : 'CALL';
                    const emoji = nz.type === 'supply' ? '🔴' : '🟢';
                    const setupType = nz.type === 'supply' ? 'Resistance' : 'Support';
                    
                    html += `
                        <div style="background: white; padding: 14px; border-radius: 10px; margin-bottom: 10px;">
                            <div style="font-weight: 600; margin-bottom: 6px;">
                                ${emoji} ${zoneType} Setup ${nz.distance.toFixed(2)} points ${nz.direction}
                            </div>
                            <div style="font-size: 0.9em; color: #6b7280;">
                                ${setupType} Zone: ${nz.zone.bottom.toFixed(2)} - ${nz.zone.top.toFixed(2)}
                            </div>
                            <div style="font-size: 0.85em; color: #4f7cff; margin-top: 4px;">
                                Wait for: Price enters zone + ${nz.type === 'supply' ? 'red reversal candle' : 'green reversal candle'}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            document.getElementById('signalContent').innerHTML = html;
        }
        
        function updateStats() {
            const trades = JSON.parse(localStorage.getItem('tradeLogs') || '[]');
            const closed = trades.filter(t => t.exitPrice);
            const winners = closed.filter(t => {
                const pl = (t.exitContractPrice - t.entryContractPrice) * 100 * (t.contracts || 1);
                return pl > 0;
            }).length;
            const totalPL = closed.reduce((sum, t) => {
                return sum + ((t.exitContractPrice - t.entryContractPrice) * 100 * (t.contracts || 1));
            }, 0);
            
            document.getElementById('totalTrades').textContent = closed.length;
            document.getElementById('winRate').textContent = closed.length ? 
                ((winners / closed.length) * 100).toFixed(1) + '%' : '0%';
            document.getElementById('totalPL').textContent = '$' + totalPL.toFixed(2);
        }
        
        function logTrade() {
            const trade = {
                id: Date.now(),
                type: document.getElementById('logTradeType').value,
                zone: document.getElementById('logZone').value,
                entryDateTime: document.getElementById('logEntryDateTime').value,
                entryPrice: parseFloat(document.getElementById('logEntryPrice').value),
                entryContractPrice: parseFloat(document.getElementById('logEntryContractPrice').value),
                contracts: parseInt(document.getElementById('logContracts').value) || 1,
                exitDateTime: document.getElementById('logExitDateTime').value,
                exitPrice: parseFloat(document.getElementById('logExitPrice').value),
                exitContractPrice: parseFloat(document.getElementById('logExitContractPrice').value)
            };
            
            if (!trade.zone || !trade.entryDateTime || !trade.entryPrice || !trade.entryContractPrice) {
                alert('Please fill in all required fields');
                return;
            }
            
            let trades = JSON.parse(localStorage.getItem('tradeLogs') || '[]');
            trades.push(trade);
            localStorage.setItem('tradeLogs', JSON.stringify(trades));
            
            // Clear inputs
            document.getElementById('logZone').value = '';
            document.getElementById('logEntryDateTime').value = '';
            document.getElementById('logEntryPrice').value = '';
            document.getElementById('logEntryContractPrice').value = '';
            document.getElementById('logContracts').value = '';
            document.getElementById('logExitDateTime').value = '';
            document.getElementById('logExitPrice').value = '';
            document.getElementById('logExitContractPrice').value = '';
            
            displayTradeLogs();
            updateStats();
            showSaveIndicator();
        }
        
        function displayTradeLogs() {
            const trades = JSON.parse(localStorage.getItem('tradeLogs') || '[]');
            const listEl = document.getElementById('tradeLogList');
            
            if (trades.length === 0) {
                listEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No trades logged yet</p>';
                return;
            }
            
            let html = '<h3 style="margin-bottom: 16px;">Trade History</h3>';
            
            trades.reverse().forEach((trade, index) => {
                const pl = trade.exitContractPrice ? 
                    (trade.exitContractPrice - trade.entryContractPrice) * 100 * trade.contracts : 0;
                const plColor = pl >= 0 ? '#10b981' : '#ef4444';
                
                html += `
                    <div style="background: #fafafa; padding: 20px; margin-bottom: 12px; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                            <div>
                                <strong style="color: ${trade.type === 'call' ? '#10b981' : '#ef4444'};">
                                    ${trade.type.toUpperCase()} • Zone: ${trade.zone}
                                </strong>
                            </div>
                            ${trade.exitContractPrice ? 
                                `<div style="font-size: 1.2em; font-weight: 700; color: ${plColor};">
                                    ${pl >= 0 ? '+' : ''}$${pl.toFixed(2)}
                                </div>` : 
                                '<div style="color: #6b7280;">Open</div>'
                            }
                        </div>
                        <div style="font-size: 0.9em; color: #6b7280;">
                            <div>Entry: ${trade.entryPrice} @ $${trade.entryContractPrice} • ${new Date(trade.entryDateTime).toLocaleString()}</div>
                            ${trade.exitPrice ? 
                                `<div>Exit: ${trade.exitPrice} @ $${trade.exitContractPrice} • ${new Date(trade.exitDateTime).toLocaleString()}</div>` : 
                                ''
                            }
                            <div>Contracts: ${trade.contracts}</div>
                        </div>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }
        
        function addWeeklyTrade() {
            const trade = {
                id: Date.now(),
                type: document.getElementById('weeklyTradeType').value,
                zone: document.getElementById('weeklyZone').value,
                entryDateTime: document.getElementById('weeklyEntryDateTime').value,
                entryPrice: parseFloat(document.getElementById('weeklyEntryPrice').value),
                exitDateTime: document.getElementById('weeklyExitDateTime').value,
                exitPrice: parseFloat(document.getElementById('weeklyExitPrice').value),
                entryContractPrice: parseFloat(document.getElementById('weeklyEntryContractPrice').value),
                exitContractPrice: parseFloat(document.getElementById('weeklyExitContractPrice').value),
                profitLoss: (parseFloat(document.getElementById('weeklyExitContractPrice').value) - 
                            parseFloat(document.getElementById('weeklyEntryContractPrice').value)) * 100
            };
            
            if (!trade.zone || !trade.entryDateTime || !trade.exitDateTime) {
                alert('Please fill in all fields');
                return;
            }
            
            let weeklyTrades = JSON.parse(localStorage.getItem('weeklyTrades') || '[]');
            weeklyTrades.push(trade);
            localStorage.setItem('weeklyTrades', JSON.stringify(weeklyTrades));
            
            // Clear inputs
            document.getElementById('weeklyZone').value = '';
            document.getElementById('weeklyEntryDateTime').value = '';
            document.getElementById('weeklyEntryPrice').value = '';
            document.getElementById('weeklyExitDateTime').value = '';
            document.getElementById('weeklyExitPrice').value = '';
            document.getElementById('weeklyEntryContractPrice').value = '';
            document.getElementById('weeklyExitContractPrice').value = '';
            
            displayWeeklyTrades();
            updatePatternAnalysis();
            showSaveIndicator();
        }
        
        function displayWeeklyTrades() {
            const trades = JSON.parse(localStorage.getItem('weeklyTrades') || '[]');
            const listEl = document.getElementById('weeklyTradesList');
            
            if (trades.length === 0) {
                listEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 12px;">No trades this week</p>';
                return;
            }
            
            let totalPL = 0;
            let html = '';
            
            trades.forEach((trade, index) => {
                totalPL += trade.profitLoss;
                const plColor = trade.profitLoss >= 0 ? '#10b981' : '#ef4444';
                
                html += `
                    <div style="background: white; padding: 16px; margin-bottom: 10px; border-radius: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <strong style="color: ${trade.type === 'CALL' ? '#10b981' : '#ef4444'};">
                                ${trade.type} • ${trade.zone}
                            </strong>
                            <span style="font-weight: 700; color: ${plColor};">
                                ${trade.profitLoss >= 0 ? '+' : ''}$${trade.profitLoss.toFixed(2)}
                            </span>
                        </div>
                        <div style="font-size: 0.85em; color: #6b7280;">
                            Entry: ${trade.entryPrice} @ $${trade.entryContractPrice}<br>
                            Exit: ${trade.exitPrice} @ $${trade.exitContractPrice}
                        </div>
                        <button onclick="removeWeeklyTrade(${index})" class="remove-zone" style="margin-top: 8px; width: auto;">Remove</button>
                    </div>
                `;
            });
            
            html = `
                <div style="background: #f0fdf4; padding: 16px; border-radius: 12px; margin-bottom: 16px; border: 2px solid #10b981;">
                    <div style="text-align: center;">
                        <div style="font-size: 0.9em; color: #065f46; font-weight: 600;">Total Weekly P&L</div>
                        <div style="font-size: 2em; font-weight: 700; color: ${totalPL >= 0 ? '#10b981' : '#ef4444'};">
                            ${totalPL >= 0 ? '+' : ''}$${totalPL.toFixed(2)}
                        </div>
                        <div style="font-size: 0.85em; color: #6b7280; margin-top: 4px;">${trades.length} trade${trades.length !== 1 ? 's' : ''}</div>
                    </div>
                </div>
            ` + html;
            
            listEl.innerHTML = html;
        }
        
        function removeWeeklyTrade(index) {
            let trades = JSON.parse(localStorage.getItem('weeklyTrades') || '[]');
            trades.splice(index, 1);
            localStorage.setItem('weeklyTrades', JSON.stringify(trades));
            displayWeeklyTrades();
            updatePatternAnalysis();
        }
        
        function updatePatternAnalysis() {
            const trades = JSON.parse(localStorage.getItem('weeklyTrades') || '[]');
            const analysisEl = document.getElementById('patternAnalysis');
            
            if (trades.length === 0) {
                analysisEl.innerHTML = '<p>Add winning trades to see pattern analysis.</p>';
                return;
            }
            
            const callTrades = trades.filter(t => t.type === 'CALL');
            const putTrades = trades.filter(t => t.type === 'PUT');
            
            const avgCallPL = callTrades.length > 0 ? 
                callTrades.reduce((sum, t) => sum + t.profitLoss, 0) / callTrades.length : 0;
            const avgPutPL = putTrades.length > 0 ? 
                putTrades.reduce((sum, t) => sum + t.profitLoss, 0) / putTrades.length : 0;
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div style="background: white; padding: 16px; border-radius: 12px;">
                        <div style="font-weight: 600; color: #10b981; margin-bottom: 8px;">🟢 CALL Trades</div>
                        <div>Count: ${callTrades.length}</div>
                        <div>Avg P&L: $${avgCallPL.toFixed(2)}</div>
                    </div>
                    <div style="background: white; padding: 16px; border-radius: 12px;">
                        <div style="font-weight: 600; color: #ef4444; margin-bottom: 8px;">🔴 PUT Trades</div>
                        <div>Count: ${putTrades.length}</div>
                        <div>Avg P&L: ${avgPutPL.toFixed(2)}</div>
                    </div>
                </div>
            `;
            
            analysisEl.innerHTML = html;
        }
        
        function saveWeeklyRecap() {
            const weekDate = document.getElementById('weekDate').value;
            const notes = document.getElementById('weeklyNotes').value;
            const trades = JSON.parse(localStorage.getItem('weeklyTrades') || '[]');
            
            if (!weekDate) {
                alert('Please select a week date');
                return;
            }
            
            const recap = {
                weekDate,
                notes,
                trades: [...trades],
                savedDate: new Date().toISOString()
            };
            
            let recaps = JSON.parse(localStorage.getItem('weeklyRecaps') || '[]');
            
            const existingIndex = recaps.findIndex(r => r.weekDate === weekDate);
            if (existingIndex >= 0) {
                recaps[existingIndex] = recap;
            } else {
                recaps.push(recap);
            }
            
            recaps.sort((a, b) => new Date(b.weekDate) - new Date(a.weekDate));
            
            localStorage.setItem('weeklyRecaps', JSON.stringify(recaps));
            localStorage.removeItem('weeklyTrades');
            
            displayWeeklyTrades();
            updatePatternAnalysis();
            displayRecapHistory();
            
            showSaveIndicator();
            alert('Weekly recap saved!');
        }
        
        function displayRecapHistory() {
            const recaps = JSON.parse(localStorage.getItem('weeklyRecaps') || '[]');
            const historyEl = document.getElementById('recapHistory');
            
            if (recaps.length === 0) {
                historyEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No saved recaps yet</p>';
                return;
            }
            
            let html = '<h3 style="margin-top: 32px; margin-bottom: 16px;">Saved Recaps</h3>';
            
            recaps.forEach((recap, index) => {
                const weekDate = new Date(recap.weekDate);
                let totalPL = 0;
                recap.trades.forEach(t => totalPL += t.profitLoss);
                const plColor = totalPL >= 0 ? '#10b981' : '#ef4444';
                
                html += `
                    <div style="background: white; padding: 20px; margin-bottom: 16px; border-radius: 12px; border: 1px solid #f0f0f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">Week of ${weekDate.toLocaleDateString()}</div>
                                <div style="font-size: 0.85em; color: #6b7280;">${recap.trades.length} trade${recap.trades.length !== 1 ? 's' : ''}</div>
                            </div>
                            <div style="font-size: 1.5em; font-weight: 700; color: ${plColor};">
                                ${totalPL >= 0 ? '+' : ''}${totalPL.toFixed(2)}
                            </div>
                        </div>
                        ${recap.notes ? `
                            <div style="background: #fafafa; padding: 12px; border-radius: 8px; margin-top: 12px; font-size: 0.9em;">
                                <strong>Notes:</strong> ${recap.notes}
                            </div>
                        ` : ''}
                        <button onclick="deleteRecap(${index})" style="margin-top: 12px; background: #ef4444; padding: 8px 16px; font-size: 0.85em; width: auto;">Delete Recap</button>
                    </div>
                `;
            });
            
            historyEl.innerHTML = html;
        }
        
        function deleteRecap(index) {
            if (confirm('Delete this recap?')) {
                let recaps = JSON.parse(localStorage.getItem('weeklyRecaps') || '[]');
                recaps.splice(index, 1);
                localStorage.setItem('weeklyRecaps', JSON.stringify(recaps));
                displayRecapHistory();
                showSaveIndicator();
            }
        }
        
        async function runZoneBehaviorAnalysis() {
            if (!polygonApiKey) {
                alert('Please connect to Polygon.io first');
                return;
            }
            
            const resultsDiv = document.getElementById('backtestResults');
            resultsDiv.innerHTML = '<div style="padding: 20px; text-align: center;"><h3>Analyzing 2 years of zone behavior patterns...</h3><p style="color: #6b7280;">Loading 4-hour bar data and analyzing zone tests, bounces, and breakouts...</p></div>';
            
            try {
                // Get 2 years of 4-hour data
                const to = new Date();
                const from = new Date();
                from.setFullYear(from.getFullYear() - 2);
                
                const fromStr = from.toISOString().split('T')[0];
                const toStr = to.toISOString().split('T')[0];
                
                const response = await fetch(
                    `https://api.polygon.io/v2/aggs/ticker/SPY/range/240/minute/${fromStr}/${toStr}?adjusted=true&sort=asc&limit=50000&apiKey=${polygonApiKey}`
                );
                
                const data = await response.json();
                
                if (!data.results || data.results.length === 0) {
                    throw new Error('No historical data available');
                }
                
                const analysis = analyzeZoneBehavior(data.results);
                displayZoneBehaviorResults(analysis, data.results.length);
                
            } catch (error) {
                resultsDiv.innerHTML = `<div style="padding: 20px; text-align: center; color: #ef4444;"><h3>Error: ${error.message}</h3></div>`;
            }
        }
        
        function analyzeZoneBehavior(candles) {
            const swingHighs = [];
            const swingLows = [];
            const zoneWidth = 3;
            
            // Identify swing highs and lows
            for (let i = 5; i < candles.length - 5; i++) {
                const current = candles[i];
                let isSwingHigh = true;
                let isSwingLow = true;
                
                // Check 5 candles on each side
                for (let j = 1; j <= 5; j++) {
                    if (candles[i - j].h >= current.h || candles[i + j].h >= current.h) {
                        isSwingHigh = false;
                    }
                    if (candles[i - j].l <= current.l || candles[i + j].l <= current.l) {
                        isSwingLow = false;
                    }
                }
                
                if (isSwingHigh) {
                    swingHighs.push({
                        index: i,
                        price: current.h,
                        top: current.h,
                        bottom: current.h - zoneWidth,
                        date: new Date(current.t)
                    });
                }
                
                if (isSwingLow) {
                    swingLows.push({
                        index: i,
                        price: current.l,
                        top: current.l + zoneWidth,
                        bottom: current.l,
                        date: new Date(current.t)
                    });
                }
            }
            
            // Analyze each swing high (supply zone)
            const supplyBehavior = swingHighs.map(swing => {
                let tests = 0;
                let bounces = 0;
                let breakouts = 0;
                let falseBreakouts = 0;
                let avgMoveAfterBounce = 0;
                let avgMoveAfterBreak = 0;
                let daysUntilFirstRetest = null;
                let totalBounceMove = 0;
                let totalBreakMove = 0;
                
                for (let i = swing.index + 1; i < candles.length; i++) {
                    const candle = candles[i];
                    
                    // Check if price entered zone
                    if (candle.h >= swing.bottom && candle.l <= swing.top) {
                        tests++;
                        
                        if (daysUntilFirstRetest === null) {
                            daysUntilFirstRetest = i - swing.index;
                        }
                        
                        // Did it bounce or break?
                        if (candle.c < swing.bottom) {
                            bounces++;
                            
                            // Measure move after bounce (next 5 days)
                            if (i + 5 < candles.length) {
                                const moveDistance = candle.c - Math.min(...candles.slice(i + 1, i + 6).map(c => c.l));
                                totalBounceMove += moveDistance;
                            }
                        } else if (candle.c > swing.top) {
                            // Potential breakout
                            breakouts++;
                            
                            // Check if false breakout (reverses within 3 days)
                            let isFalse = false;
                            for (let j = i + 1; j < Math.min(i + 4, candles.length); j++) {
                                if (candles[j].c < swing.bottom) {
                                    isFalse = true;
                                    falseBreakouts++;
                                    break;
                                }
                            }
                            
                            if (!isFalse && i + 5 < candles.length) {
                                const moveDistance = Math.max(...candles.slice(i + 1, i + 6).map(c => c.h)) - candle.c;
                                totalBreakMove += moveDistance;
                            }
                        }
                    }
                }
                
                avgMoveAfterBounce = bounces > 0 ? totalBounceMove / bounces : 0;
                avgMoveAfterBreak = (breakouts - falseBreakouts) > 0 ? totalBreakMove / (breakouts - falseBreakouts) : 0;
                
                return {
                    zone: swing,
                    tests,
                    bounces,
                    breakouts,
                    falseBreakouts,
                    avgMoveAfterBounce,
                    avgMoveAfterBreak,
                    daysUntilFirstRetest
                };
            });
            
            // Analyze each swing low (demand zone)
            const demandBehavior = swingLows.map(swing => {
                let tests = 0;
                let bounces = 0;
                let breakouts = 0;
                let falseBreakouts = 0;
                let avgMoveAfterBounce = 0;
                let avgMoveAfterBreak = 0;
                let daysUntilFirstRetest = null;
                let totalBounceMove = 0;
                let totalBreakMove = 0;
                
                for (let i = swing.index + 1; i < candles.length; i++) {
                    const candle = candles[i];
                    
                    if (candle.l <= swing.top && candle.h >= swing.bottom) {
                        tests++;
                        
                        if (daysUntilFirstRetest === null) {
                            daysUntilFirstRetest = i - swing.index;
                        }
                        
                        if (candle.c > swing.top) {
                            bounces++;
                            
                            if (i + 5 < candles.length) {
                                const moveDistance = Math.max(...candles.slice(i + 1, i + 6).map(c => c.h)) - candle.c;
                                totalBounceMove += moveDistance;
                            }
                        } else if (candle.c < swing.bottom) {
                            breakouts++;
                            
                            let isFalse = false;
                            for (let j = i + 1; j < Math.min(i + 4, candles.length); j++) {
                                if (candles[j].c > swing.top) {
                                    isFalse = true;
                                    falseBreakouts++;
                                    break;
                                }
                            }
                            
                            if (!isFalse && i + 5 < candles.length) {
                                const moveDistance = candle.c - Math.min(...candles.slice(i + 1, i + 6).map(c => c.l));
                                totalBreakMove += Math.abs(moveDistance);
                            }
                        }
                    }
                }
                
                avgMoveAfterBounce = bounces > 0 ? totalBounceMove / bounces : 0;
                avgMoveAfterBreak = (breakouts - falseBreakouts) > 0 ? totalBreakMove / (breakouts - falseBreakouts) : 0;
                
                return {
                    zone: swing,
                    tests,
                    bounces,
                    breakouts,
                    falseBreakouts,
                    avgMoveAfterBounce,
                    avgMoveAfterBreak,
                    daysUntilFirstRetest
                };
            });
            
            return {
                supply: supplyBehavior,
                demand: demandBehavior
            };
        }
        
        function displayZoneBehaviorResults(analysis, totalDays) {
            const supply = analysis.supply.filter(s => s.tests > 0);
            const demand = analysis.demand.filter(d => d.tests > 0);
            
            // Calculate aggregate statistics
            const avgSupplyTests = supply.reduce((sum, s) => sum + s.tests, 0) / supply.length;
            const avgSupplyBounces = supply.reduce((sum, s) => sum + s.bounces, 0) / supply.length;
            const avgSupplyBreakouts = supply.reduce((sum, s) => sum + s.breakouts, 0) / supply.length;
            const avgSupplyFalseBreaks = supply.reduce((sum, s) => sum + s.falseBreakouts, 0) / supply.length;
            const avgDaysToSupplyRetest = supply.reduce((sum, s) => sum + (s.daysUntilFirstRetest || 0), 0) / supply.length;
            
            const avgDemandTests = demand.reduce((sum, d) => sum + d.tests, 0) / demand.length;
            const avgDemandBounces = demand.reduce((sum, d) => sum + d.bounces, 0) / demand.length;
            const avgDemandBreakouts = demand.reduce((sum, d) => sum + d.breakouts, 0) / demand.length;
            const avgDemandFalseBreaks = demand.reduce((sum, d) => sum + d.falseBreakouts, 0) / demand.length;
            const avgDaysToDemandRetest = demand.reduce((sum, d) => sum + (d.daysUntilFirstRetest || 0), 0) / demand.length;
            
            let html = '<div style="background: white; padding: 24px; border-radius: 16px; border: 1px solid #f0f0f0;">';
            html += '<h3 style="margin-bottom: 20px;">Zone Behavior Patterns (2 Years of Data)</h3>';
            html += `<p style="color: #6b7280; margin-bottom: 24px;">Analyzed ${supply.length} supply zones and ${demand.length} demand zones across ${totalDays} trading days</p>`;
            
            // Supply zones summary
            html += '<div style="background: #fef2f2; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #ef4444;">';
            html += '<h4 style="color: #ef4444; margin-bottom: 16px;">🔴 Supply Zone (Resistance) Behavior</h4>';
            html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">';
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Avg Tests Before Break</div>
                <div style="font-size: 1.8em; font-weight: 700; color: #0d0d0d;">${avgSupplyTests.toFixed(1)}</div>
            </div>`;
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Avg Bounces</div>
                <div style="font-size: 1.8em; font-weight: 700; color: #10b981;">${avgSupplyBounces.toFixed(1)}</div>
            </div>`;
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">False Breakouts</div>
                <div style="font-size: 1.8em; font-weight: 700; color: #f59e0b;">${avgSupplyFalseBreaks.toFixed(1)}</div>
            </div>`;
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">4H Bars to First Retest</div>
                <div style="font-size: 1.8em; font-weight: 700; color: #4f7cff;">${avgDaysToSupplyRetest.toFixed(0)}</div>
            </div>`;
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Bounce Success Rate</div>
                <div style="font-size: 1.8em; font-weight: 700; color: #10b981;">${((avgSupplyBounces / avgSupplyTests) * 100).toFixed(0)}%</div>
            </div>`;
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Avg Breakouts</div>
                <div style="font-size: 1.8em; font-weight: 700; color: #ef4444;">${avgSupplyBreakouts.toFixed(1)}</div>
            </div>`;
            html += '</div></div>';
            
            // Demand zones summary
            html += '<div style="background: #f0fdf4; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #10b981;">';
            html += '<h4 style="color: #10b981; margin-bottom: 16px;">🟢 Demand Zone (Support) Behavior</h4>';
            html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">';
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Avg Tests Before Break</div>
                <div style="font-size: 1.8em; font-weight: 700; color: #0d0d0d;">${avgDemandTests.toFixed(1)}</div>
            </div>`;
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Avg Bounces</div>
                <div style="font-size: 1.8em; font-weight: 700; color: #10b981;">${avgDemandBounces.toFixed(1)}</div>
            </div>`;
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">False Breakouts</div>
                <div style="font-size: 1.8em; font-weight: 700; color: #f59e0b;">${avgDemandFalseBreaks.toFixed(1)}</div>
            </div>`;
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">4H Bars to First Retest</div>
                <div style="font-size: 1.8em; font-weight: 700; color: #4f7cff;">${avgBarsToDemandRetest.toFixed(0)}</div>
            </div>`;
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Bounce Success Rate</div>
                <div style="font-size: 1.8em; font-weight: 700; color: #10b981;">${((avgDemandBounces / avgDemandTests) * 100).toFixed(0)}%</div>
            </div>`;
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Avg Breakouts</div>
                <div style="font-size: 1.8em; font-weight: 700; color: #ef4444;">${avgDemandBreakouts.toFixed(1)}</div>
            </div>`;
            html += '</div></div>';
            
            // Key insights
            html += '<div style="background: #dbeafe; padding: 20px; border-radius: 12px; border-left: 4px solid #4f7cff;">';
            html += '<h4 style="color: #1e40af; margin-bottom: 12px;">💡 Key Insights</h4>';
            html += '<ul style="list-style: none; padding: 0; color: #0d0d0d;">';
            html += `<li style="margin-bottom: 8px;">• Zones typically get tested ${Math.round((avgSupplyTests + avgDemandTests) / 2)} times before breaking</li>`;
            html += `<li style="margin-bottom: 8px;">• Average ${Math.round(avgBarsToSupplyRetest)} 4H bars until first retest of resistance</li>`;
            html += `<li style="margin-bottom: 8px;">• False breakouts occur ${Math.round(((avgSupplyFalseBreaks + avgDemandFalseBreaks) / 2) / ((avgSupplyBreakouts + avgDemandBreakouts) / 2) * 100)}% of the time</li>`;
            html += `<li>• Bounce success rate: Supply ${((avgSupplyBounces / avgSupplyTests) * 100).toFixed(0)}%, Demand ${((avgDemandBounces / avgDemandTests) * 100).toFixed(0)}%</li>`;
            html += '</ul></div>';
            
            html += '</div>';
            
            // Add download button
            html += '<div style="margin-top: 24px; text-align: center;">';
            html += '<button onclick="downloadBacktestResults()" style="background: #10b981; padding: 14px 28px; font-size: 1.05em; width: auto;">📥 Download Results as JSON</button>';
            html += '</div>';
            
            document.getElementById('backtestResults').innerHTML = html;
            
            // Store results globally for download
            window.backtestResultsData = {
                summary: {
                    totalTrades,
                    winRate,
                    avgWin,
                    avgLoss,
                    totalPL,
                    avgRR,
                    totalDays
                },
                byConfidence: {
                    high: {
                        trades: highConfTrades.length,
                        winRate: highWinRate,
                        winners: highConfTrades.filter(t => t.winner).length
                    },
                    medium: {
                        trades: medConfTrades.length,
                        winRate: medWinRate,
                        winners: medConfTrades.filter(t => t.winner).length
                    },
                    low: {
                        trades: lowConfTrades.length,
                        winRate: lowWinRate,
                        winners: lowConfTrades.filter(t => t.winner).length
                    }
                },
                byType: {
                    calls: {
                        trades: callTrades.length,
                        winRate: callWinRate,
                        winners: callTrades.filter(t => t.winner).length
                    },
                    puts: {
                        trades: putTrades.length,
                        winRate: putWinRate,
                        winners: putTrades.filter(t => t.winner).length
                    }
                },
                exitReasons: {
                    stopLoss: stopLossExits,
                    takeProfit: takeProfitExits,
                    timeExit: timeExits
                },
                monthlyPerformance: monthlyData,
                allTrades: trades.map(t => ({
                    type: t.type,
                    entry: t.entry,
                    exit: t.exitPrice,
                    stopLoss: t.stopLoss,
                    takeProfit: t.takeProfit,
                    pl: t.pl,
                    plPercent: t.plPercent,
                    winner: t.winner,
                    confidence: t.confidence,
                    confidenceTier: t.confidenceTier,
                    exitReason: t.exitReason,
                    zone: t.zone,
                    entryDate: t.entryDate.toISOString(),
                    exitDate: t.exitDate.toISOString(),
                    daysInTrade: t.exitIndex - t.entryIndex
                })),
                detectedZones: {
                    supply: results.detectedZones.supply.map(z => ({
                        top: z.top,
                        bottom: z.bottom,
                        confidence: z.confidence,
                        tests: z.tests,
                        bounces: z.bounces,
                        date: z.date
                    })),
                    demand: results.detectedZones.demand.map(z => ({
                        top: z.top,
                        bottom: z.bottom,
                        confidence: z.confidence,
                        tests: z.tests,
                        bounces: z.bounces,
                        date: z.date
                    }))
                },
                metadata: {
                    backtestDate: new Date().toISOString(),
                    dataSource: 'Polygon.io',
                    timeframe: '2 years daily data',
                    strategyVersion: 'V02',
                    strategyRules: {
                        entry: 'Price in zone + reversal candle + 75%+ confidence',
                        stopLoss: 'Zone edge + 75% zone width',
                        takeProfit: '1.5R or 50% to next zone (whichever closer)',
                        timeExit: '7 days (simulating 7 DTE options)',
                        zoneManagement: 'Delete zone after 2 stop losses'
                    },
                    changes: {
                        v01_to_v02: [
                            'Widened stops from 50% to 75% zone width',
                            'Raised confidence threshold from 70% to 75%',
                            'Changed profit target from next zone to 1.5R or 50% to zone',
                            'Added zone management: disable after 2 stop losses'
                        ]
                    }
                }
            };
        }
        
        function downloadBacktestResults() {
            if (!window.backtestResultsData) {
                alert('⚠️ No backtest results available.\n\nPlease run a backtest first by clicking "🎯 Run Strategy Backtest (2 Years)"');
                return;
            }
            
            try {
                const dataStr = JSON.stringify(window.backtestResultsData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `spy-backtest-results-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                // Show success message
                const successDiv = document.createElement('div');
                successDiv.style.cssText = 'position: fixed; top: 80px; right: 24px; background: #10b981; color: white; padding: 20px 24px; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 12px rgba(16,185,129,0.3); z-index: 10000; animation: slideIn 0.3s ease;';
                successDiv.innerHTML = '✓ Backtest results downloaded!<br><span style="font-size: 0.9em; font-weight: 400;">Upload this JSON file to Claude for analysis</span>';
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    successDiv.style.opacity = '0';
                    successDiv.style.transition = 'opacity 0.3s';
                    setTimeout(() => successDiv.remove(), 300);
                }, 4000);
                
            } catch (error) {
                alert('❌ Download failed: ' + error.message + '\n\nPlease try running the backtest again.');
                console.error('Download error:', error);
            }
        }
        
        async function runStrategyBacktest() {
            if (!polygonApiKey) {
                alert('Please connect to Polygon.io first');
                return;
            }
            
            const resultsDiv = document.getElementById('backtestResults');
            resultsDiv.innerHTML = '<div style="padding: 20px; text-align: center;"><h3>🎯 Running Strategy Backtest...</h3><p style="color: #6b7280;">Loading 2 years of 4-hour candle data and simulating trades with your exact rules...</p><p style="color: #6b7280; margin-top: 12px;">This will take 30-60 seconds</p></div>';
            
            try {
                // Get 2 years of data - we'll use daily bars and simulate 4H behavior
                const to = new Date();
                const from = new Date();
                from.setFullYear(from.getFullYear() - 2);
                
                const fromStr = from.toISOString().split('T')[0];
                const toStr = to.toISOString().split('T')[0];
                
                const response = await fetch(
                    `https://api.polygon.io/v2/aggs/ticker/SPY/range/240/minute/${fromStr}/${toStr}?adjusted=true&sort=asc&limit=50000&apiKey=${polygonApiKey}`
                );
                
                if (!response.ok) {
                    throw new Error('Failed to load historical data');
                }
                
                const data = await response.json();
                
                if (!data.results || data.results.length === 0) {
                    throw new Error('No historical data available');
                }
                
                // Detect zones from historical data
                const detectedZones = detectZones(data.results);
                
                // Run backtest simulation
                const backtestResults = simulateTrades(data.results, detectedZones);
                
                // Display results
                displayBacktestResults(backtestResults, data.results.length);
                
            } catch (error) {
                resultsDiv.innerHTML = `<div style="padding: 20px; text-align: center; color: #ef4444;"><h3>Error: ${error.message}</h3></div>`;
            }
        }
        
        function simulateTrades(candles, detectedZones) {
            const trades = [];
            let activePosition = null;
            const zoneStopLossCount = {}; // Track stop losses per zone
            const disabledZones = new Set(); // Zones that hit 2 stop losses
            
            // Combine all zones
            const allZones = [
                ...detectedZones.supply.map(z => ({ ...z, type: 'supply', id: `supply_${z.bottom}_${z.top}` })),
                ...detectedZones.demand.map(z => ({ ...z, type: 'demand', id: `demand_${z.bottom}_${z.top}` }))
            ];
            
            // Initialize stop loss counters
            allZones.forEach(zone => {
                zoneStopLossCount[zone.id] = 0;
            });
            
            // Simulate each day
            for (let i = 5; i < candles.length; i++) {
                const candle = candles[i];
                const prevCandle = candles[i - 1];
                
                // Check if we have an active position - manage exits first
                if (activePosition) {
                    let exitReason = null;
                    let exitPrice = null;
                    
                    // Check stop loss hit
                    if (activePosition.type === 'call' && candle.l <= activePosition.stopLoss) {
                        exitReason = 'stop_loss';
                        exitPrice = activePosition.stopLoss;
                    } else if (activePosition.type === 'put' && candle.h >= activePosition.stopLoss) {
                        exitReason = 'stop_loss';
                        exitPrice = activePosition.stopLoss;
                    }
                    
                    // Check take profit hit
                    if (!exitReason && activePosition.takeProfit) {
                        if (activePosition.type === 'call' && candle.h >= activePosition.takeProfit) {
                            exitReason = 'take_profit';
                            exitPrice = activePosition.takeProfit;
                        } else if (activePosition.type === 'put' && candle.l <= activePosition.takeProfit) {
                            exitReason = 'take_profit';
                            exitPrice = activePosition.takeProfit;
                        }
                    }
                    
                    // Check time-based exit (7 days = 7 DTE options expiring)
                    if (!exitReason && i >= activePosition.entryIndex + 7) {
                        exitReason = 'time_exit';
                        exitPrice = candle.c;
                    }
                    
                    // Exit trade if any condition met
                    if (exitReason) {
                        const pl = activePosition.type === 'call' ? 
                            exitPrice - activePosition.entry : 
                            activePosition.entry - exitPrice;
                        
                        const winner = pl > 0;
                        
                        // Track zone stop losses
                        if (exitReason === 'stop_loss' && !winner) {
                            zoneStopLossCount[activePosition.zoneId]++;
                            
                            // Disable zone if it hit 2 stop losses
                            if (zoneStopLossCount[activePosition.zoneId] >= 2) {
                                disabledZones.add(activePosition.zoneId);
                            }
                        }
                        
                        trades.push({
                            ...activePosition,
                            exitPrice,
                            exitReason,
                            exitIndex: i,
                            exitDate: new Date(candle.t),
                            pl,
                            plPercent: (pl / Math.abs(activePosition.entry - activePosition.stopLoss)) * 100,
                            winner
                        });
                        
                        activePosition = null;
                    }
                }
                
                // Look for new trade entries (only if no active position)
                if (!activePosition) {
                    for (const zone of allZones) {
                        // Skip disabled zones
                        if (disabledZones.has(zone.id)) continue;
                        
                        // Check if price entered the zone
                        const inZone = candle.h >= zone.bottom && candle.l <= zone.top;
                        
                        if (inZone) {
                            let validEntry = false;
                            let entryPrice = null;
                            let confidence = 50;
                            
                            // SUPPLY ZONE (PUT) logic
                            if (zone.type === 'supply') {
                                // Need bearish reversal candle
                                if (candle.c < candle.o) {
                                    validEntry = true;
                                    entryPrice = candle.c;
                                    confidence += 20; // Reversal candle present
                                    
                                    // Check trend (simple: compare to 20-day MA)
                                    if (i >= 20) {
                                        const ma20 = candles.slice(i - 20, i).reduce((sum, c) => sum + c.c, 0) / 20;
                                        if (candle.c < ma20) {
                                            confidence += 20; // Downtrend
                                        } else {
                                            confidence -= 15; // Uptrend
                                        }
                                    }
                                    
                                    // Price position in zone
                                    const zoneHeight = zone.top - zone.bottom;
                                    const pricePosition = (candle.c - zone.bottom) / zoneHeight;
                                    if (pricePosition > 0.7) confidence += 10;
                                    
                                    confidence = Math.max(0, Math.min(100, confidence));
                                }
                            }
                            
                            // DEMAND ZONE (CALL) logic
                            if (zone.type === 'demand') {
                                // Need bullish reversal candle
                                if (candle.c > candle.o) {
                                    validEntry = true;
                                    entryPrice = candle.c;
                                    confidence += 20; // Reversal candle present
                                    
                                    // Check trend
                                    if (i >= 20) {
                                        const ma20 = candles.slice(i - 20, i).reduce((sum, c) => sum + c.c, 0) / 20;
                                        if (candle.c > ma20) {
                                            confidence += 20; // Uptrend
                                        } else {
                                            confidence -= 15; // Downtrend
                                        }
                                    }
                                    
                                    // Price position
                                    const zoneHeight = zone.top - zone.bottom;
                                    const pricePosition = (candle.c - zone.bottom) / zoneHeight;
                                    if (pricePosition < 0.3) confidence += 10;
                                    
                                    confidence = Math.max(0, Math.min(100, confidence));
                                }
                            }
                            
                            // V02: Only take trades with 75%+ confidence
                            if (validEntry && confidence >= 75) {
                                // V02: Calculate stop loss with 75% zone width (was 50%)
                                const zoneWidth = zone.top - zone.bottom;
                                const stopLoss = zone.type === 'supply' ? 
                                    zone.top + (zoneWidth * 0.75) : 
                                    zone.bottom - (zoneWidth * 0.75);
                                
                                // Calculate risk distance
                                const riskDistance = Math.abs(entryPrice - stopLoss);
                                
                                // V02: Find take profit using 1.5R or 50% to next zone (whichever closer)
                                let takeProfit = null;
                                let targetFromRR = null;
                                let targetFromZone = null;
                                
                                // Calculate 1.5R target
                                if (zone.type === 'supply') {
                                    targetFromRR = entryPrice - (riskDistance * 1.5);
                                } else {
                                    targetFromRR = entryPrice + (riskDistance * 1.5);
                                }
                                
                                // Find next zone and calculate 50% target
                                if (zone.type === 'supply') {
                                    // Look for demand zone below
                                    const lowerZones = allZones
                                        .filter(z => z.type === 'demand' && z.top < entryPrice && !disabledZones.has(z.id))
                                        .sort((a, b) => b.top - a.top);
                                    if (lowerZones.length > 0) {
                                        const distanceToZone = entryPrice - lowerZones[0].top;
                                        targetFromZone = entryPrice - (distanceToZone * 0.5);
                                    }
                                } else {
                                    // Look for supply zone above
                                    const upperZones = allZones
                                        .filter(z => z.type === 'supply' && z.bottom > entryPrice && !disabledZones.has(z.id))
                                        .sort((a, b) => a.bottom - b.bottom);
                                    if (upperZones.length > 0) {
                                        const distanceToZone = upperZones[0].bottom - entryPrice;
                                        targetFromZone = entryPrice + (distanceToZone * 0.5);
                                    }
                                }
                                
                                // Choose closer target
                                if (targetFromRR && targetFromZone) {
                                    const distRR = Math.abs(targetFromRR - entryPrice);
                                    const distZone = Math.abs(targetFromZone - entryPrice);
                                    takeProfit = distRR < distZone ? targetFromRR : targetFromZone;
                                } else {
                                    takeProfit = targetFromRR || targetFromZone;
                                }
                                
                                // Create position
                                activePosition = {
                                    type: zone.type === 'supply' ? 'put' : 'call',
                                    entry: entryPrice,
                                    stopLoss,
                                    takeProfit,
                                    entryIndex: i,
                                    entryDate: new Date(candle.t),
                                    zone: `${zone.bottom.toFixed(2)}-${zone.top.toFixed(2)}`,
                                    zoneId: zone.id,
                                    confidence,
                                    confidenceTier: confidence >= 75 ? 'high' : confidence >= 50 ? 'medium' : 'low'
                                };
                                
                                break; // Only one trade at a time
                            }
                        }
                    }
                }
            }
            
            return {
                trades,
                detectedZones,
                disabledZones: Array.from(disabledZones)
            };
        }
        
        function displayBacktestResults(results, totalDays) {
            const trades = results.trades;
            const winners = trades.filter(t => t.winner);
            const losers = trades.filter(t => !t.winner);
            
            // Overall stats
            const totalTrades = trades.length;
            const winRate = totalTrades > 0 ? (winners.length / totalTrades) * 100 : 0;
            const avgWin = winners.length > 0 ? winners.reduce((sum, t) => sum + t.pl, 0) / winners.length : 0;
            const avgLoss = losers.length > 0 ? Math.abs(losers.reduce((sum, t) => sum + t.pl, 0) / losers.length) : 0;
            const totalPL = trades.reduce((sum, t) => sum + t.pl, 0);
            const avgRR = avgLoss > 0 ? avgWin / avgLoss : 0;
            
            // By confidence tier
            const highConfTrades = trades.filter(t => t.confidenceTier === 'high');
            const medConfTrades = trades.filter(t => t.confidenceTier === 'medium');
            const lowConfTrades = trades.filter(t => t.confidenceTier === 'low');
            
            const highWinRate = highConfTrades.length > 0 ? 
                (highConfTrades.filter(t => t.winner).length / highConfTrades.length) * 100 : 0;
            const medWinRate = medConfTrades.length > 0 ? 
                (medConfTrades.filter(t => t.winner).length / medConfTrades.length) * 100 : 0;
            const lowWinRate = lowConfTrades.length > 0 ? 
                (lowConfTrades.filter(t => t.winner).length / lowConfTrades.length) * 100 : 0;
            
            // By trade type
            const callTrades = trades.filter(t => t.type === 'call');
            const putTrades = trades.filter(t => t.type === 'put');
            const callWinRate = callTrades.length > 0 ? 
                (callTrades.filter(t => t.winner).length / callTrades.length) * 100 : 0;
            const putWinRate = putTrades.length > 0 ? 
                (putTrades.filter(t => t.winner).length / putTrades.length) * 100 : 0;
            
            // Exit reasons
            const stopLossExits = trades.filter(t => t.exitReason === 'stop_loss').length;
            const takeProfitExits = trades.filter(t => t.exitReason === 'take_profit').length;
            const timeExits = trades.filter(t => t.exitReason === 'time_exit').length;
            
            // Monthly breakdown
            const monthlyData = {};
            trades.forEach(trade => {
                const month = trade.entryDate.toISOString().slice(0, 7); // YYYY-MM
                if (!monthlyData[month]) {
                    monthlyData[month] = { trades: [], pl: 0 };
                }
                monthlyData[month].trades.push(trade);
                monthlyData[month].pl += trade.pl;
            });
            
            // STORE DATA FIRST - before building HTML
            window.backtestResultsData = {
                summary: {
                    totalTrades,
                    winRate,
                    avgWin,
                    avgLoss,
                    totalPL,
                    avgRR,
                    totalDays
                },
                byConfidence: {
                    high: {
                        trades: highConfTrades.length,
                        winRate: highWinRate,
                        winners: highConfTrades.filter(t => t.winner).length
                    },
                    medium: {
                        trades: medConfTrades.length,
                        winRate: medWinRate,
                        winners: medConfTrades.filter(t => t.winner).length
                    },
                    low: {
                        trades: lowConfTrades.length,
                        winRate: lowWinRate,
                        winners: lowConfTrades.filter(t => t.winner).length
                    }
                },
                byType: {
                    calls: {
                        trades: callTrades.length,
                        winRate: callWinRate,
                        winners: callTrades.filter(t => t.winner).length
                    },
                    puts: {
                        trades: putTrades.length,
                        winRate: putWinRate,
                        winners: putTrades.filter(t => t.winner).length
                    }
                },
                exitReasons: {
                    stopLoss: stopLossExits,
                    takeProfit: takeProfitExits,
                    timeExit: timeExits
                },
                monthlyPerformance: monthlyData,
                allTrades: trades.map(t => ({
                    type: t.type,
                    entry: t.entry,
                    exit: t.exitPrice,
                    stopLoss: t.stopLoss,
                    takeProfit: t.takeProfit,
                    pl: t.pl,
                    plPercent: t.plPercent,
                    winner: t.winner,
                    confidence: t.confidence,
                    confidenceTier: t.confidenceTier,
                    exitReason: t.exitReason,
                    zone: t.zone,
                    entryDate: t.entryDate.toISOString(),
                    exitDate: t.exitDate.toISOString(),
                    daysInTrade: t.exitIndex - t.entryIndex
                })),
                detectedZones: {
                    supply: results.detectedZones.supply.map(z => ({
                        top: z.top,
                        bottom: z.bottom,
                        confidence: z.confidence,
                        tests: z.tests,
                        bounces: z.bounces,
                        date: z.date
                    })),
                    demand: results.detectedZones.demand.map(z => ({
                        top: z.top,
                        bottom: z.bottom,
                        confidence: z.confidence,
                        tests: z.tests,
                        bounces: z.bounces,
                        date: z.date
                    }))
                },
                metadata: {
                    backtestDate: new Date().toISOString(),
                    dataSource: 'Polygon.io',
                    timeframe: '2 years of 4-hour bar data',
                    strategyRules: {
                        entry: 'Price in zone + reversal candle + trend check',
                        stopLoss: 'Zone edge + 50% zone width',
                        takeProfit: 'Next zone level',
                        timeExit: '7 days (simulating 7 DTE options)'
                    }
                }
            };
            
            console.log('✓ Backtest data stored, ready for download:', window.backtestResultsData);
            
            let html = '<div style="background: white; padding: 24px; border-radius: 16px; border: 1px solid #f0f0f0;">';
            html += '<h3 style="margin-bottom: 20px;">📊 Strategy Backtest Results (2 Years)</h3>';
            html += `<p style="color: #6b7280; margin-bottom: 24px;">Simulated ${totalTrades} trades across ${totalDays} trading days using detected supply/demand zones</p>`;
            
            // Overall performance
            html += '<div style="background: #dbeafe; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #4f7cff;">';
            html += '<h4 style="color: #1e40af; margin-bottom: 16px;">Overall Performance</h4>';
            html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">';
            
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Total Trades</div>
                <div style="font-size: 1.8em; font-weight: 700; color: #0d0d0d;">${totalTrades}</div>
            </div>`;
            
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Win Rate</div>
                <div style="font-size: 1.8em; font-weight: 700; color: ${winRate >= 50 ? '#10b981' : '#ef4444'};">${winRate.toFixed(1)}%</div>
            </div>`;
            
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Avg R:R</div>
                <div style="font-size: 1.8em; font-weight: 700; color: ${avgRR >= 1.5 ? '#10b981' : '#f59e0b'};">1:${avgRR.toFixed(2)}</div>
            </div>`;
            
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Total P&L</div>
                <div style="font-size: 1.8em; font-weight: 700; color: ${totalPL >= 0 ? '#10b981' : '#ef4444'};">${totalPL >= 0 ? '+' : ''}${totalPL.toFixed(2)}</div>
            </div>`;
            
            html += '</div></div>';
            
            // By confidence level
            html += '<div style="background: #fffbeb; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">';
            html += '<h4 style="color: #92400e; margin-bottom: 16px;">Performance by Confidence Level</h4>';
            html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">';
            
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">High (70%+)</div>
                <div style="font-size: 1.6em; font-weight: 700; color: #10b981;">${highWinRate.toFixed(1)}%</div>
                <div style="font-size: 0.85em; color: #6b7280; margin-top: 4px;">${highConfTrades.length} trades</div>
            </div>`;
            
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Medium (50-70%)</div>
                <div style="font-size: 1.6em; font-weight: 700; color: #f59e0b;">${medWinRate.toFixed(1)}%</div>
                <div style="font-size: 0.85em; color: #6b7280; margin-top: 4px;">${medConfTrades.length} trades</div>
            </div>`;
            
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Low (<50%)</div>
                <div style="font-size: 1.6em; font-weight: 700; color: #ef4444;">${lowWinRate.toFixed(1)}%</div>
                <div style="font-size: 0.85em; color: #6b7280; margin-top: 4px;">${lowConfTrades.length} trades</div>
            </div>`;
            
            html += '</div></div>';
            
            // Trade breakdown
            html += '<div style="background: #f0fdf4; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #10b981;">';
            html += '<h4 style="color: #065f46; margin-bottom: 16px;">Trade Breakdown</h4>';
            html += '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px;">';
            
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">CALLs</div>
                <div style="font-size: 1.6em; font-weight: 700; color: #10b981;">${callWinRate.toFixed(1)}%</div>
                <div style="font-size: 0.85em; color: #6b7280; margin-top: 4px;">${callTrades.length} trades</div>
            </div>`;
            
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">PUTs</div>
                <div style="font-size: 1.6em; font-weight: 700; color: #ef4444;">${putWinRate.toFixed(1)}%</div>
                <div style="font-size: 0.85em; color: #6b7280; margin-top: 4px;">${putTrades.length} trades</div>
            </div>`;
            
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Stop Loss</div>
                <div style="font-size: 1.6em; font-weight: 700; color: #ef4444;">${stopLossExits}</div>
                <div style="font-size: 0.85em; color: #6b7280; margin-top: 4px;">${((stopLossExits / totalTrades) * 100).toFixed(0)}%</div>
            </div>`;
            
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Take Profit</div>
                <div style="font-size: 1.6em; font-weight: 700; color: #10b981;">${takeProfitExits}</div>
                <div style="font-size: 0.85em; color: #6b7280; margin-top: 4px;">${((takeProfitExits / totalTrades) * 100).toFixed(0)}%</div>
            </div>`;
            
            html += `<div style="background: white; padding: 16px; border-radius: 8px;">
                <div style="font-size: 0.85em; color: #6b7280;">Time Exit (7D)</div>
                <div style="font-size: 1.6em; font-weight: 700; color: #f59e0b;">${timeExits}</div>
                <div style="font-size: 0.85em; color: #6b7280; margin-top: 4px;">${((timeExits / totalTrades) * 100).toFixed(0)}%</div>
            </div>`;
            
            html += '</div></div>';
            
            // Monthly performance
            const months = Object.keys(monthlyData).sort();
            if (months.length > 0) {
                html += '<div style="background: #fafafa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">';
                html += '<h4 style="margin-bottom: 16px;">Monthly Performance</h4>';
                html += '<div style="display: grid; gap: 8px; max-height: 400px; overflow-y: auto;">';
                
                months.forEach(month => {
                    const data = monthlyData[month];
                    const monthWinRate = (data.trades.filter(t => t.winner).length / data.trades.length) * 100;
                    const plColor = data.pl >= 0 ? '#10b981' : '#ef4444';
                    
                    html += `
                        <div style="background: white; padding: 16px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">${month}</div>
                                <div style="font-size: 0.85em; color: #6b7280;">${data.trades.length} trades • ${monthWinRate.toFixed(0)}% win rate</div>
                            </div>
                            <div style="font-size: 1.3em; font-weight: 700; color: ${plColor};">
                                ${data.pl >= 0 ? '+' : ''}${data.pl.toFixed(2)}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }
            
            // Key insights
            html += '<div style="background: #dbeafe; padding: 20px; border-radius: 12px; border-left: 4px solid #4f7cff;">';
            html += '<h4 style="color: #1e40af; margin-bottom: 12px;">💡 Key Insights</h4>';
            html += '<ul style="list-style: none; padding: 0; color: #0d0d0d;">';
            
            if (highWinRate > medWinRate + 10) {
                html += '<li style="margin-bottom: 8px;">• ✓ High confidence signals (70%+) significantly outperformed - stick to these</li>';
            } else {
                html += '<li style="margin-bottom: 8px;">• ⚠️ Confidence scoring didn\'t strongly predict winners - may need adjustment</li>';
            }
            
            if (avgRR >= 1.5) {
                html += '<li style="margin-bottom: 8px;">• ✓ Risk:Reward ratio is favorable - good zone-to-zone targeting</li>';
            } else {
                html += '<li style="margin-bottom: 8px;">• ⚠️ Low R:R - consider wider profit targets or tighter stops</li>';
            }
            
            if (takeProfitExits > stopLossExits) {
                html += '<li style="margin-bottom: 8px;">• ✓ More trades hit profit target than stop loss - zones are working</li>';
            } else {
                html += '<li style="margin-bottom: 8px;">• ⚠️ More stop losses than profit targets - may need better zone selection</li>';
            }
            
            if (Math.abs(callWinRate - putWinRate) < 10) {
                html += '<li style="margin-bottom: 8px;">• ✓ Balanced performance between CALLs and PUTs</li>';
            } else if (callWinRate > putWinRate) {
                html += '<li style="margin-bottom: 8px;">• ⚠️ CALLs performed significantly better - consider focusing on demand zones</li>';
            } else {
                html += '<li style="margin-bottom: 8px;">• ⚠️ PUTs performed significantly better - consider focusing on supply zones</li>';
            }
            
            html += '<li style="margin-bottom: 8px;">• Remember: Past results don\'t guarantee future performance</li>';
            html += '<li>• Markets change - what worked 2023-2025 may not work going forward</li>';
            
            html += '</ul></div>';
            
            html += '</div>';
            
            document.getElementById('backtestResults').innerHTML = html;
        }
        
        function deleteRecap(index) {
            if (confirm('Delete this recap?')) {
                let recaps = JSON.parse(localStorage.getItem('weeklyRecaps') || '[]');
                recaps.splice(index, 1);
                localStorage.setItem('weeklyRecaps', JSON.stringify(recaps));
                displayRecapHistory();
                showSaveIndicator();
            }
        }
        
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
            document.getElementById(pageName + 'Page').classList.add('active');
            document.getElementById(pageName + 'Tab').classList.add('active');
        }
        
        ['trend', 'lastCandle'].forEach(id => {
            document.getElementById(id).addEventListener('change', () => {
                generateSignals();
                saveAllData();
            });
        });
        
        window.addEventListener('load', () => {
            loadSavedData();
            const today = new Date();
            const monday = new Date(today.setDate(today.getDate() - today.getDay() + 1));
            document.getElementById('weekDate').value = monday.toISOString().split('T')[0];
        });
    </script>
</body>
</html>
